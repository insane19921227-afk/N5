<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚å…‰ç…§ç›¸é¤¨ N5 å§”è¨—ç³»çµ± V18.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --cheng-blue: #2d8cf0; --lu-white: #f8fafc; --dark-bg: #0f172a; --glass: rgba(15, 23, 42, 0.95);
            --danger: #ef4444; --warning: #f59e0b; --success: #10b981;
            --border-n: #9ca3af; --border-r: #3b82f6; --border-sr: #eab308; --border-sqr: #000;
        }
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans JP', sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh;
            background-image: url('link-click.png'); background-size: cover; background-position: center; background-attachment: fixed;
            user-select: none; color: white;
        }
        body::before { content: ""; position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7); z-index: -1; }
        
        .app-container { width: 95%; max-width: 500px; min-height: 700px; position: relative; padding-bottom: 50px; }
        .hidden { display: none !important; }

        /* å¡ç‰‡èˆ‡æŒ‰éˆ• */
        .glass-card {
            background: var(--glass); backdrop-filter: blur(15px); border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.1); padding: 30px; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.6); animation: fadeIn 0.5s; position: relative; overflow: hidden;
        }
        .film-strip-top, .film-strip-bottom {
            position: absolute; left: 0; width: 100%; height: 15px; opacity: 0.5;
            background-image: linear-gradient(to right, transparent 50%, rgba(255,255,255,0.3) 50%); background-size: 20px 100%;
        }
        .film-strip-top { top: 0; } .film-strip-bottom { bottom: 0; }

        .big-btn {
            background: var(--cheng-blue); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .big-btn:hover { transform: translateY(-3px); background: #1a73e8; }
        .darkroom-btn { background: #333; border: 1px solid #555; color: #aaa; }
        .report-center-btn { background: #b45309; }
        .gallery-btn { background: linear-gradient(45deg, #7c3aed, #db2777); border: 1px solid #e879f9; }

        /* å„€è¡¨æ¿ */
        h1 { margin: 0; font-size: 1.8rem; text-shadow: 0 0 10px var(--cheng-blue); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .stat-val { font-size: 1.3rem; font-weight: 900; color: var(--cheng-blue); }
        .stat-label { font-size: 0.7rem; color: #cbd5e1; }

        .category-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; text-align: left; }
        .cat-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; display: flex; flex-direction: column; justify-content: center; min-height: 80px; }
        .cat-card:hover { background: rgba(255,255,255,0.2); border-color: var(--cheng-blue); transform: translateY(-2px); }

        /* è¨­å®šå½ˆçª— */
        .setup-modal { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(15,23,42,0.98); z-index:10; display:none; flex-direction:column; justify-content:center; padding:30px; }
        .count-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .count-btn { padding: 12px; border: 2px solid #334155; background: transparent; border-radius: 8px; cursor: pointer; font-weight: bold; color: #94a3b8; }
        .count-btn.active { border-color: var(--cheng-blue); color: var(--cheng-blue); background: rgba(45,140,240,0.1); }
        .challenge-section { background: #1e293b; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; }
        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--danger); }
        input:checked + .slider:before { transform: translateX(24px); }
        .setting-sub-box { margin-top: 10px; border-top: 1px dashed #475569; padding-top: 10px; display: none; }
        select { width: 100%; padding: 8px; background: #0f172a; color: white; border: 1px solid #475569; border-radius: 5px; }

        /* ç•«å»Š */
        .gallery-header { margin-bottom: 15px; }
        .filter-section { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: left; }
        .filter-label { font-size: 0.8rem; color: #94a3b8; margin-bottom: 5px; display: block; }
        .checkbox-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .filter-chk { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; cursor: pointer; }
        .gallery-content { max-height: 450px; overflow-y: auto; padding-right: 5px; text-align: left; }
        .group-title { color: var(--cheng-blue); font-size: 1.1rem; font-weight: bold; margin: 20px 0 10px 0; border-bottom: 1px solid rgba(45,140,240,0.3); padding-bottom: 5px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        .photo-card { background: #0f172a; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; position: relative; aspect-ratio: 3/4; }
        .photo-card:hover { transform: scale(1.05); z-index: 2; }
        .photo-img { width: 100%; height: 100%; object-fit: cover; }
        .photo-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 3px; background: rgba(0,0,0,0.7); font-size: 0.6rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .border-N { border: 2px solid var(--border-n); } .border-R { border: 2px solid var(--border-r); box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
        .border-SR { border: 2px solid var(--border-sr); box-shadow: 0 0 10px rgba(234, 179, 8, 0.6); } .border-SQR { border: 2px solid #ffd700; box-shadow: 0 0 15px gold; }

        /* å›å ± */
        .report-list { max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: left; }
        .report-item { display: flex; align-items: flex-start; gap: 10px; border-bottom: 1px solid #334155; padding: 8px 0; }
        .report-id { color: var(--warning); font-weight: bold; font-family: monospace; }

        /* æ¸¬é©—ä»‹é¢ */
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .hearts-container { color: var(--danger); font-size: 1.2rem; text-shadow: 0 0 10px var(--danger); }
        .timer-display { font-family: monospace; font-size: 1.1rem; color: var(--warning); border: 1px solid var(--warning); padding: 2px 8px; border-radius: 4px; display: none; }
        .timer-display.urgent { color: var(--danger); border-color: var(--danger); animation: shake 0.5s infinite; }
        .meta-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .q-tag { background: rgba(45, 140, 240, 0.2); color: var(--cheng-blue); padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; border: 1px solid var(--cheng-blue); }
        .id-badge { font-family: 'Courier New', monospace; font-size: 0.8rem; color: #64748b; border: 1px solid #334155; padding: 2px 8px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .id-badge:hover { color: white; border-color: var(--cheng-blue); background: rgba(45,140,240,0.1); }
        .question-text { font-size: 1.4rem; font-weight: bold; margin: 10px 0 20px; line-height: 1.6; text-shadow: 1px 1px 2px black; user-select: text !important; cursor: text; }
        .option-btn { width: 100%; background: rgba(255,255,255,0.9); color: #0f172a; border: none; padding: 15px; border-radius: 8px; margin-bottom: 10px; text-align: left; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .option-btn.correct { background: #dcfce7; color: #166534; } .option-btn.wrong { background: #fee2e2; color: #991b1b; }

        .explanation-box { background: #f8fafc; border-left: 4px solid var(--cheng-blue); padding: 20px; margin-top: 25px; border-radius: 0 12px 12px 0; display: none; color:#333; text-align:left; animation: fadeIn 0.5s; }
        .tools-area { display: flex; gap: 10px; margin-top: 15px; }
        .tool-btn { border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: bold; transition: 0.2s; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tool-btn:active { transform: scale(0.95); }
        .btn-copy { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-copy:hover { background: linear-gradient(135deg, #60a5fa, #3b82f6); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .btn-bug { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-bug:hover { background: linear-gradient(135deg, #fbbf24, #f59e0b); box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
        .btn-bug.disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; box-shadow: none; }

        /* ç‡ˆç®±èˆ‡æŠ½å¡ */
        .lightbox-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .lightbox-img { max-width: 90%; max-height: 80vh; object-fit: contain; border: 2px solid white; box-shadow: 0 0 30px rgba(255,255,255,0.2); }
        .gacha-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 50; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .gacha-card-reveal { width: 250px; height: 350px; background: #333; border-radius: 15px; display: flex; justify-content: center; align-items: center; opacity: 0; transform: scale(0.5); transition: all 0.5s; }
        .gacha-card-reveal.show { opacity: 1; transform: scale(1); }

        .result-view { display: none; text-align: center; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; border: 5px solid var(--cheng-blue); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 0 20px var(--cheng-blue); background: rgba(0,0,0,0.5); }
        .heal-anim { animation: heal 0.5s ease-in-out; }
        @keyframes heal { 0% { transform: scale(1); } 50% { transform: scale(1.3); color: var(--success); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        /* --- æ–°å¢æ¨£å¼ V18.2 --- */
/* å·¦ä¸Šè§’ç¢ç‰‡é¡¯ç¤º */
.shard-badge {
    position: absolute; top: 15px; left: 15px;
    background: rgba(0,0,0,0.6); border: 1px solid var(--border-sr);
    color: #ffd700; padding: 5px 12px; border-radius: 20px;
    font-weight: bold; font-family: monospace; font-size: 1.1rem;
    display: flex; align-items: center; gap: 8px; z-index: 5;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

/* æŠ½å¡ä¸­å¿ƒä»‹é¢ */
.gacha-pool-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
.pool-card {
    min-width: 120px; flex: 1; background: linear-gradient(180deg, #1e293b, #0f172a);
    border: 2px solid #334155; border-radius: 12px; padding: 15px 5px;
    cursor: pointer; position: relative; transition: 0.2s;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.pool-card.active { border-color: var(--cheng-blue); background: rgba(45,140,240,0.1); box-shadow: 0 0 15px rgba(45,140,240,0.3); }
.pool-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: white; }
.pool-icon { font-size: 2rem; margin-bottom: 5px; }

.gacha-actions { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; text-align: center; }
.cost-display { color: #ffd700; margin-bottom: 15px; font-weight: bold; }
.btn-pull { 
    background: linear-gradient(45deg, #2563eb, #1d4ed8); border: none; padding: 10px 20px; 
    border-radius: 8px; color: white; font-weight: bold; cursor: pointer; width: 48%;
    display: inline-flex; flex-direction: column; align-items: center; gap: 2px;
}
.btn-pull:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
.btn-pull span { font-size: 0.8rem; opacity: 0.9; }

/* æŠ½å¡çµæœå±•ç¤º */
.pull-result-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 15px; }
.mini-card { 
    aspect-ratio: 3/4; background: #333; border-radius: 4px; overflow: hidden; position: relative; 
    border: 2px solid #555; animation: zoomIn 0.3s backwards;
}
.mini-new-badge { position: absolute; top: 0; right: 0; background: var(--danger); color: white; font-size: 0.5rem; padding: 1px 3px; }

/* ç›¸ç°¿æ•¸é‡æ¨™è¨˜ */
.qty-badge {
    position: absolute; bottom: 2px; right: 2px;
    background: rgba(0,0,0,0.8); color: white;
    font-size: 0.7rem; padding: 1px 6px; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.3); font-family: monospace;
}
/* --- Beta æŒ‰éˆ•èˆ‡ä¿åº•é¡¯ç¤º --- */
.beta-btn {
    position: absolute; top: 15px; right: 15px;
    background: rgba(255, 255, 255, 0.1); color: #64748b;
    border: 1px solid #334155; padding: 5px 10px;
    border-radius: 8px; font-size: 0.8rem; cursor: pointer;
    font-family: monospace; transition: 0.2s;
}
.beta-btn:hover { background: rgba(255, 255, 255, 0.2); color: white; }

.pity-counter-display {
    background: rgba(0, 0, 0, 0.4); border-radius: 4px;
    padding: 2px 8px; font-size: 0.75rem; color: #f59e0b;
    display: inline-block; margin-top: 5px; border: 1px dashed #f59e0b;
}
    </style>
</head>
<body>

    <div class="app-container">
<!-- ä¸»å„€è¡¨æ¿ -->
        <div id="dashboard" class="glass-card">
            <!-- å·¦ä¸Šè§’ï¼šæ™‚å…‰ç¢ç‰‡ -->
            <div class="shard-badge">
                <span>ğŸ’ </span> <span id="shard-count">0</span>
            </div>
            
            <!-- å³ä¸Šè§’ï¼šBeta é–‹ç™¼è€…æŒ‰éˆ• -->
            <button class="beta-btn" onclick="activateBeta()">BETA</button>

            <div class="film-strip-top"></div>
            <h1>TIME PHOTO STUDIO</h1>
            
            <div class="stats-grid">
                <!-- åŸæœ¬çš„çµ±è¨ˆæ•¸æ“šä¿æŒä¸è®Š -->
                <div class="stat-box"><div class="stat-val" id="stat-total">0</div><div class="stat-label">å®Œæˆå§”è¨—</div></div>
                <div class="stat-box"><div class="stat-val" id="stat-accuracy">0%</div><div class="stat-label">åŒæ­¥ç‡</div></div>
                <div class="stat-box"><div class="stat-val" id="stat-photo-count">0</div><div class="stat-label">ç›¸ç‰‡æ”¶é›†</div></div>
                <div class="stat-box"><div class="stat-val" id="stat-streak" style="color:#f59e0b">0</div><div class="stat-label">é€£å‹</div></div>
            </div>

            <div style="text-align:left; margin-bottom:10px; font-weight:bold; color:#cbd5e1;">ğŸ“‚ é¸æ“‡å§”è¨—é¡åˆ¥ï¼š</div>
            <div id="category-container" class="category-grid"></div>

            <button class="big-btn" onclick="openSetup('ALL')">âš¡ ç¶œåˆæ½›å…¥ (éš¨æ©Ÿ)</button>
            <button class="big-btn darkroom-btn" onclick="openDarkroom()">ğŸ“· é€²å…¥æš—æˆ¿ (éŒ¯é¡Œé‡ä¿®)</button>
            
            <!-- æ–°å¢ï¼šæŠ½å¡æŒ‰éˆ• -->
            <button class="big-btn" style="background: linear-gradient(45deg, #0ea5e9, #6366f1);" onclick="openGachaCenter()">ğŸ”® æ™‚å…‰æŠ½å¡ä¸­å¿ƒ</button>
            
            <button class="big-btn report-center-btn" onclick="openReportCenter()">âš  å•é¡Œå›å ±ä¸­å¿ƒ</button>
            <button class="big-btn gallery-btn" onclick="openGallery()">ğŸ–¼ï¸ å§”è¨—æˆå°±åº«</button>

            <div style="margin-top:20px; font-size:0.8rem; color:#64748b; cursor:pointer;" onclick="resetStats()">[ é‡ç½®æ‰€æœ‰è¨˜éŒ„ ]</div>
            <div class="film-strip-bottom"></div>
        </div>

        <!-- ç•«å»Š -->
        <div id="gallery-screen" class="glass-card hidden">
            <div class="film-strip-top"></div>
            <div class="gallery-header"><h2>å§”è¨—æˆå°±</h2></div>
            <div class="filter-section">
                <div class="filter-label">æ’åºæ–¹å¼ï¼š</div>
                <select id="gallery-sort" style="margin-bottom:10px; width:100%; padding:5px; background:#0f172a; color:white;" onchange="renderGallery()">
                    <option value="char">æŒ‰äººç‰©åˆ†çµ„</option>
                    <option value="rarity">æŒ‰ç¨€æœ‰åº¦åˆ†çµ„</option>
                </select>
                <div class="filter-label">äººç‰©ç¯©é¸ï¼š</div>
                <div class="checkbox-group" id="filter-chars">
                    <label class="filter-chk"><input type="checkbox" value="ç¨‹å°æ™‚&é™¸å…‰" checked onchange="renderGallery()"> é›™äºº</label>
                    <label class="filter-chk"><input type="checkbox" value="ç¨‹å°æ™‚" checked onchange="renderGallery()"> ç¨‹å°æ™‚</label>
                    <label class="filter-chk"><input type="checkbox" value="é™¸å…‰" checked onchange="renderGallery()"> é™¸å…‰</label>
                </div>
                <div class="filter-label" style="margin-top:5px;">ç­‰ç´šç¯©é¸ï¼š</div>
                <div class="checkbox-group" id="filter-ranks">
                    <label class="filter-chk"><input type="checkbox" value="N" checked onchange="renderGallery()"> N</label>
                    <label class="filter-chk"><input type="checkbox" value="R" checked onchange="renderGallery()"> R</label>
                    <label class="filter-chk"><input type="checkbox" value="SR" checked onchange="renderGallery()"> SR</label>
                    <label class="filter-chk"><input type="checkbox" value="SQR" checked onchange="renderGallery()"> SQR</label>
                </div>
            </div>
            <div id="gallery-content" class="gallery-content"></div>
            <button class="big-btn" style="margin-top:20px;" onclick="closeGallery()">è¿”å›ç¸½éƒ¨</button>
            <div class="film-strip-bottom"></div>
        </div>
        <!-- æŠ½å¡ä¸­å¿ƒä»‹é¢ (V18.3 æ›´æ–°) -->
        <div id="gacha-screen" class="glass-card hidden">
            <!-- è¨­å®šï¼šY=å¿…ä¸é‡è¤‡, N=å¯é‡è¤‡ -->
            <div id="gacha-config" data-no-duplicate="Y" style="display:none;"></div>

            <div class="film-strip-top"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">æ™‚å…‰ç¯€é»</h2>
                <div style="background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:15px; color:#ffd700; font-weight:bold;">
                    ğŸ’  <span id="gacha-shard-display">0</span>
                </div>
            </div>

            <div class="gacha-pool-container">
                <div class="pool-card active" onclick="selectPool('duo', this)">
                    <div class="pool-icon">ğŸ‘¥</div>
                    <div class="pool-title">é›™äººæ­æª”</div>
                    <div style="font-size:0.6rem; color:#aaa;">ç¨‹å°æ™‚ & é™¸å…‰</div>
                </div>
                <div class="pool-card" onclick="selectPool('cheng', this)">
                    <div class="pool-icon">ğŸ“·</div> <!-- Emoji æ”¹ç‚ºç›¸æ©Ÿ -->
                    <div class="pool-title">ç¨‹å°æ™‚</div>
                    <div style="font-size:0.6rem; color:#aaa;">ç†±è¡€ç³»</div>
                </div>
                <div class="pool-card" onclick="selectPool('lu', this)">
                    <div class="pool-icon">âŒš</div> <!-- Emoji æ”¹ç‚ºæ‡·éŒ¶ -->
                    <div class="pool-title">é™¸å…‰</div>
                    <div style="font-size:0.6rem; color:#aaa;">å†·éœç³»</div>
                </div>
            </div>

            <div class="gacha-actions">
                <div id="pool-desc" style="margin-bottom:5px; color:#94a3b8; font-size:0.9rem;">
                    N:60% | R:30% | SR:7.5% | SQR:2.5%
                </div>
                <!-- æ–°å¢ï¼šç´¯ç©æŠ½æ•¸é¡¯ç¤º -->
                <div id="pity-display" class="pity-counter-display">
                    ç´¯ç©æŠ½æ•¸: 0 (ä¿åº• SR: 80 / SQR: 160)
                </div>
                
                <div style="display:flex; justify-content:space-between; margin-top:15px;">
                    <button class="btn-pull" onclick="executePull(1)">
                        æŠ½å– 1 æ¬¡
                        <span>ğŸ’  100</span>
                    </button>
                    <button class="btn-pull" onclick="executePull(10)">
                        æŠ½å– 10 æ¬¡
                        <span>ğŸ’  1000 (ä¿åº•R)</span>
                    </button>
                </div>
            </div>

            <!-- æŠ½å¡çµæœé¡¯ç¤ºå€ -->
            <div id="pull-results" class="pull-result-grid"></div>

            <button class="big-btn" style="margin-top:20px; background:#475569;" onclick="closeGachaCenter()">è¿”å›ç¸½éƒ¨</button>
            <div class="film-strip-bottom"></div>
        </div>

            

        <!-- è¨­å®šå½ˆçª— -->
        <div id="setup-modal" class="setup-modal">
            <h2 style="color:white; margin-bottom:5px;">ä»»å‹™åƒæ•¸</h2>
            <div style="margin-bottom:10px; color:#cbd5e1;">é¡Œæ•¸ï¼š</div>
            <div class="count-grid">
                <button class="count-btn active" onclick="selectCount(5, this)">5</button>
                <button class="count-btn" onclick="selectCount(10, this)">10</button>
                <button class="count-btn" onclick="selectCount(20, this)">20</button>
            </div>
            <div class="challenge-section">
                <div class="switch-row">
                    <span style="font-weight:bold; color:#ef4444;">ğŸ”¥ æŒ‘æˆ°æ¨¡å¼</span>
                    <label class="switch"><input type="checkbox" id="challenge-toggle" onchange="toggleChallengeMode()"><span class="slider"></span></label>
                </div>
                <div id="heart-setting" class="setting-sub-box">
                    <label style="font-size:0.8rem; color:#94a3b8;">åˆå§‹è¡€é‡ï¼š</label>
                    <select id="heart-count">
                        <option value="1">1 â¤</option><option value="2">2 â¤</option><option value="3" selected>3 â¤</option><option value="4">4 â¤</option><option value="5">5 â¤</option>
                    </select>
                    <div class="switch-row" style="margin-top:10px; border-top:1px dashed #334155; padding-top:10px;">
                        <span style="font-weight:bold; color:#f59e0b;">â³ é™æ™‚ç­”é¡Œ</span>
                        <label class="switch" style="width:40px; height:20px;"><input type="checkbox" id="timer-toggle" onchange="toggleTimerMode()"><span class="slider"></span></label>
                    </div>
                    <div id="timer-setting" style="display:none; margin-top:5px;">
                        <select id="time-limit"><option value="5">5s</option><option value="12" selected>12s</option><option value="20">20s</option></select>
                    </div>
                </div>
            </div>
            <button class="big-btn" onclick="confirmStart()">ğŸš€ DIVES</button>
            <div style="margin-top:20px; color:#64748b; cursor:pointer; text-align:center;" onclick="closeSetup()">å–æ¶ˆ</div>
        </div>

        <!-- å›å ±ä¸­å¿ƒ -->
        <div id="report-modal" class="setup-modal">
            <h2 style="color:var(--warning); margin-bottom:5px;">å•é¡Œå›å ±ä¸­å¿ƒ</h2>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button style="background:#334155; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="toggleSelectAllReports()">å…¨é¸/å–æ¶ˆ</button>
            </div>
            <div id="report-list-container" class="report-list"></div>
            <button class="big-btn" style="background:var(--success);" onclick="resolveReports()">âœ… æ¨™è¨˜ç‚ºå·²è™•ç†</button>
            <div style="margin-top:20px; color:#64748b; cursor:pointer; text-align:center;" onclick="closeReportCenter()">é—œé–‰</div>
        </div>

        <!-- æ¸¬é©—ä»‹é¢ -->
        <div id="quiz-screen" class="glass-card hidden">
            <div class="film-strip-top"></div>
            <div class="quiz-header">
                <div><span id="q-progress">Q.1</span> <span id="score-display" style="margin-left:10px;">SCORE:0</span></div>
                <div style="display:flex; gap:10px;">
                    <div id="timer-display" class="timer-display">12s</div>
                    <div id="hearts-container" class="hearts-container" style="display:none;">â¤â¤â¤</div>
                </div>
            </div>
            <div class="meta-row">
                <span class="q-tag" id="q-category-tag">æ–‡æ³•</span>
                <span class="id-badge" onclick="copyId()">ID: <span id="q-db-id">--</span></span>
            </div>
            <div class="question-text" id="q-text">Loading...</div>
            <div id="options-container"></div>
            
            <div class="explanation-box" id="exp-box">
                <div style="font-weight:bold; margin-bottom:10px;">ğŸ“ è§£æ</div>
                <div id="static-exp-text"></div>
                <div class="tools-area">
                    <button class="tool-btn btn-copy" onclick="copyToClipboard()">
                        <span>ğŸ“‹</span> å•AI
                    </button>
                    <button id="btn-report-bug" class="tool-btn btn-bug" onclick="reportCurrentQuestion()">
                        <span>âš </span> å›å ±
                    </button>
                </div>
                <span id="copy-msg" style="font-size:0.8rem; color:#22c55e; display:none; margin-left:10px;">å·²è¤‡è£½ï¼</span>
            </div>
            <button class="big-btn" id="next-btn" style="margin-top:20px; display:none;" onclick="nextQuestion()">ä¸‹ä¸€å¼µ â¯</button>
            <div class="film-strip-bottom"></div>
        </div>

<!-- çµæœç•«é¢ (é€™è£¡æœ‰æ–°å¢çå‹µé¡¯ç¤ºå€å¡Š) -->
        <div class="glass-card hidden" id="result-view">
            <div class="film-strip-top"></div>
            <h2 id="result-title">ä»»å‹™å ±å‘Š</h2>
            <div class="score-circle" id="final-score">100</div>
            
            <div id="fail-img-wrapper" style="display:none; margin-bottom:20px;">
                <img src="Fail_images.png" style="max-width:100%; border-radius:10px; border:2px solid #ef4444;">
            </div>

            <!-- ğŸ”¥ æ–°å¢çš„éƒ¨åˆ†é–‹å§‹ï¼šç”¨ä¾†é¡¯ç¤ºæŠ½åˆ°çš„å¡ç‰‡ -->
            <div id="reward-container" style="display:none; margin-bottom:20px; animation: zoomIn 0.5s;">
                <div style="color:#fbbf24; font-weight:bold; margin-bottom:5px;">âœ¨ æœ¬æ¬¡å§”è¨—çå‹µ</div>
                <div id="reward-card-mini" style="width:120px; height:160px; margin:0 auto; background:#333; border-radius:8px; overflow:hidden; border:2px solid white;">
                    <!-- JS æœƒåœ¨é€™è£¡æ’å…¥åœ–ç‰‡ -->
                </div>
                <div id="reward-name" style="font-size:0.9rem; margin-top:5px; color:#cbd5e1;"></div>
            </div>
            <!-- ğŸ”¥ æ–°å¢çš„éƒ¨åˆ†çµæŸ -->

            <p id="feedback-text" style="color:#cbd5e1; margin-bottom:30px;">çµç®—ä¸­...</p>
            <button class="big-btn" onclick="location.reload()">è¿”å›ç¸½éƒ¨</button>
            <div class="film-strip-bottom"></div>
        </div>

        <!-- æŠ½å¡èˆ‡ç‡ˆç®± (é€™éƒ¨åˆ†ä¿æŒä¸è®Š) -->
        <div id="gacha-overlay" class="gacha-overlay">
            <div class="gacha-flash"></div>
            <div style="color:white; font-size:1.5rem; margin-bottom:20px; z-index:2;">âœ¨ ç²å¾—æ–°å§”è¨—ç…§ç‰‡ï¼</div>
            <div id="gacha-card-reveal" class="gacha-card-reveal"></div>
            <div id="gacha-info" style="color:white; margin-top:20px; font-size:1.2rem; font-weight:bold; z-index:2;"></div>
            <button class="big-btn" style="margin-top:30px; z-index:2; width:200px;" onclick="closeGacha()">æ”¶ä¸‹</button>
        </div>
        <div id="lightbox" class="lightbox-modal" onclick="closeLightbox()">
            <div class="lightbox-img-container" onclick="event.stopPropagation()">
                <img id="lightbox-img" class="lightbox-img" src="">
            </div>
            <div class="lightbox-info">
                <div id="lightbox-title" class="lightbox-title"></div>
                <div id="lightbox-rarity" class="lightbox-meta"></div>
            </div>
        </div>

<script>
        // --- æ ¸å¿ƒè³‡æ–™èˆ‡è®Šæ•¸ V18.3 ---
        let allQuestions = [], quizList = [], currentIdx = 0, score = 0;
        let tempSelectedCategory = 'ALL', tempSelectedCount = 5;
        let isChallengeMode = false, isTimerMode = false, timeLimit = 12, timerInterval = null, timeLeft = 0;
        let maxHearts = 3, currentHearts = 3, isGameOver = false, pendingHeal = false;

        // ä¿åº•é¡Œåº«
        const FALLBACK_QUESTIONS = [
            {id:101, section:"æ–‡æ³•", type:"åŠ©è©", question:"ã‚ãŸã—ã¯ã€€æ˜æ—¥ã€€å‹é”ï¼¿ï¼¿ï¼¿ä¼šã„ã¾ã™ã€‚", options:["ã«", "ã‚’", "ã§", "ã¸"], answer:0, explanation:"ã€æ­£è§£ï¼šã«ã€‘å‹•è©ã€Œä¼šã„ã¾ã™ã€çš„å°è±¡ç”¨ã€Œã«ã€ã€‚"},
            {id:102, section:"æ–‡æ³•", type:"å‹•è©", question:"æœ¬ã‚’ã€€ï¼¿ï¼¿ï¼¿ãã ã•ã„ã€‚", options:["èª­ã‚€", "èª­ã‚“ã§", "èª­ã¿ã¦", "èª­ã‚“ã¦"], answer:1, explanation:"ã€æ­£è§£ï¼šèª­ã‚“ã§ã€‘è«‹åšæŸäº‹ç”¨ã€Œã¦å½¢ã€ã€‚"},
            {id:103, section:"èªå½™", type:"åè©", question:"æœºã®ä¸Šã«ã€€<span style='text-decoration:underline'>é‰›ç­†</span>ã€€ãŒã‚ã‚Šã¾ã™ã€‚", options:["ãˆã‚“ã³ã¤", "ãˆã‚“ã´ã¤", "ã¯ãª", "ã‹ã°ã‚“"], answer:1, explanation:"ã€æ­£è§£ï¼šãˆã‚“ã´ã¤ã€‘é‰›ç­† = enpitsu"},
            {id:104, section:"æ–‡æ³•", type:"ç–‘å•è©", question:"èª•ç”Ÿæ—¥ã¯ã€€ï¼¿ï¼¿ï¼¿ã§ã™ã‹ã€‚", options:["ã„ã¤", "ã©ã‚Œ", "ã ã‚Œ", "ã©ã†"], answer:0, explanation:"ã€æ­£è§£ï¼šã„ã¤ã€‘å•æ™‚é–“ç”¨ã€Œã„ã¤ã€ã€‚"},
            {id:105, section:"è®€è§£", type:"çŸ­æ–‡", question:"ã€Œæ—¥æ›œæ—¥ã¯å›³æ›¸é¤¨ã«è¡Œãã¾ã›ã‚“ã€‚ã€<br>è³ªå•ï¼šæ—¥æ›œæ—¥ã¯ã©ã“ã«è¡Œãã¾ã™ã‹ã€‚", options:["å›³æ›¸é¤¨", "å­¦æ ¡", "ã‚ã‹ã‚Šã¾ã›ã‚“", "ä¼šç¤¾"], answer:2, explanation:"ã€æ­£è§£ï¼šã‚ã‹ã‚Šã¾ã›ã‚“ã€‘æ–‡ä¸­æœªæåŠè¦å»å“ªã€‚"}
        ];

        // ä¿åº•ç›¸ç‰‡
        const FALLBACK_PHOTOS = [
            {id: "p001", title: "åˆå§‹çš„å§”è¨—", character: "ç¨‹å°æ™‚&é™¸å…‰", rarity: "N", path: "https://via.placeholder.com/300x400/2d8cf0/ffffff?text=LINK+CLICK+N"},
            {id: "p002", title: "æ ¡åœ’è§’è½", character: "é™¸å…‰", rarity: "R", path: "https://via.placeholder.com/300x400/3b82f6/ffffff?text=LU+GUANG+R"},
            {id: "p003", title: "ç±ƒçƒå ´", character: "ç¨‹å°æ™‚", rarity: "SR", path: "https://via.placeholder.com/300x400/eab308/ffffff?text=CHENG+SR"}
        ];

        // æ•¸æ“šè®€å–
        let userStats = JSON.parse(localStorage.getItem('jlpt_n5_stats_v18')) || { total: 0, correct: 0, streak: 0 };
        let wrongQuestions = JSON.parse(localStorage.getItem('jlpt_n5_wrong_list')) || [];
        let reportList = JSON.parse(localStorage.getItem('jlpt_n5_reports')) || [];
        
        // æ”¶é›†å†Šèˆ‡ç¢ç‰‡
        let collectedPhotos = {}; 
        let rawCollection = JSON.parse(localStorage.getItem('jlpt_n5_collection'));
        let userShards = parseInt(localStorage.getItem('jlpt_n5_shards')) || 0;
        
        // ğŸ”¥ V18.3 æ›´æ–°ï¼šå…¨åŸŸå…±ç”¨ä¿åº•è¨ˆæ•¸ (ä¸å†å€åˆ†å¡æ± )
        let globalPity = JSON.parse(localStorage.getItem('jlpt_n5_global_pity')) || { sr: 0, sqr: 0 };

        // è³‡æ–™é·ç§» (Array -> Object)
        if (Array.isArray(rawCollection)) {
            rawCollection.forEach(id => { collectedPhotos[id] = 1; });
            localStorage.setItem('jlpt_n5_collection', JSON.stringify(collectedPhotos));
        } else if (rawCollection) {
            collectedPhotos = rawCollection;
        }

        let photoDB = [];
        let currentPool = 'duo'; 

        // åˆå§‹åŒ–
        window.onload = async () => {
            await loadData();
            await loadPhotoDB();
            updateDashboard();
            renderCategories();
        };

        async function loadData() {
            try {
                const res = await fetch('n5_questions.json');
                if(!res.ok) throw new Error();
                allQuestions = await res.json();
            } catch (e) { allQuestions = FALLBACK_QUESTIONS; }
        }

        async function loadPhotoDB() {
            try {
                const res = await fetch('photos.json');
                if(!res.ok) throw new Error();
                photoDB = await res.json();
            } catch (e) { photoDB = FALLBACK_PHOTOS; }
            updateDashboard();
        }

        // --- Beta é–‹ç™¼è€…åŠŸèƒ½ (V18.3) ---
        function activateBeta() {
            const code = prompt("ã€Beta é–‹ç™¼è€…æ¨¡å¼ã€‘\nè«‹è¼¸å…¥æš—è™Ÿï¼š");
            if (code === "SC&LG") {
                // 1. è£œå……ç¢ç‰‡
                userShards = 9999;
                localStorage.setItem('jlpt_n5_shards', userShards);
                
                // 2. è§£é–æ‰€æœ‰ç›¸ç‰‡
                if(photoDB.length === 0) photoDB = FALLBACK_PHOTOS;
                photoDB.forEach(p => {
                    // å¦‚æœæ²’æ“æœ‰ï¼Œè¨­ç‚º1ï¼›å·²æ“æœ‰å‰‡ä¸è®Š
                    if (!collectedPhotos[p.id]) collectedPhotos[p.id] = 1;
                });
                localStorage.setItem('jlpt_n5_collection', JSON.stringify(collectedPhotos));
                
                alert("âœ¨ æš—è™Ÿæ­£ç¢ºï¼\n- æ™‚å…‰ç¢ç‰‡å·²è¨­ç‚º 9999\n- å§”è¨—æˆå°±åº«å·²å…¨æ•¸è§£é–");
                location.reload(); // é‡æ–°æ•´ç†ä»¥æ›´æ–°æ‰€æœ‰ä»‹é¢
            } else {
                alert("â›” æš—è™ŸéŒ¯èª¤");
            }
        }

        // --- å„€è¡¨æ¿æ›´æ–° ---
        function updateDashboard() {
            document.getElementById('stat-total').innerText = userStats.total;
            const acc = userStats.total === 0 ? 0 : Math.round((userStats.correct / userStats.total) * 100);
            document.getElementById('stat-accuracy').innerText = acc + "%";
            
            const uniqueCount = Object.keys(collectedPhotos).length;
            document.getElementById('stat-photo-count').innerText = `${uniqueCount}/${photoDB.length}`;
            document.getElementById('stat-streak').innerText = userStats.streak || 0;

            document.getElementById('shard-count').innerText = userShards;
            document.getElementById('gacha-shard-display').innerText = userShards;
        }

        // --- æŠ½å¡ä¸­å¿ƒé‚è¼¯ (V18.3) ---
        function openGachaCenter() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('gacha-screen').classList.remove('hidden');
            document.getElementById('pull-results').innerHTML = ''; 
            updatePityDisplay();
            updateDashboard();
        }
        
        function closeGachaCenter() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('gacha-screen').classList.add('hidden');
        }

        function updatePityDisplay() {
            document.getElementById('pity-display').innerText = 
                `ç´¯ç©æŠ½æ•¸: ${globalPity.sqr} (ä¿åº• SR: ${80 - (globalPity.sr % 80)} / SQR: ${160 - (globalPity.sqr % 160)})`;
        }

        function selectPool(pool, el) {
            currentPool = pool;
            document.querySelectorAll('.pool-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function executePull(amount) {
            if (photoDB.length === 0) return alert("ç›¸ç‰‡è³‡æ–™åº«æœªè¼‰å…¥ï¼Œç„¡æ³•æŠ½å¡");
            const cost = amount * 100;
            if (userShards < cost) return alert(`æ™‚å…‰ç¢ç‰‡ä¸è¶³ï¼éœ€è¦ ${cost} ç¢ç‰‡`);
            
            userShards -= cost;
            localStorage.setItem('jlpt_n5_shards', userShards);
            document.getElementById('gacha-shard-display').innerText = userShards;
            document.getElementById('shard-count').innerText = userShards;

            const resultsContainer = document.getElementById('pull-results');
            resultsContainer.innerHTML = ''; 
            
            for (let i = 0; i < amount; i++) {
                // 10æŠ½ä¿åº•(R) - ç°¡å–®åˆ¤å®šï¼šç¬¬10å¼µå¿…Rä»¥ä¸Š
                let minRarity = (amount === 10 && i === 9) ? 'R' : 'N';
                
                setTimeout(() => {
                    const result = rollOne(currentPool, minRarity);
                    displayPullResult(result, resultsContainer);
                    updatePityDisplay(); // æ›´æ–°ä»‹é¢ä¸Šçš„ä¿åº•æ•¸
                }, i * 150);
            }
        }

        function rollOne(poolType, minRarity) {
            // 1. å…¨åŸŸä¿åº•è¨ˆæ•¸å¢åŠ 
            globalPity.sr++;
            globalPity.sqr++;

            // 2. æ±ºå®šç¨€æœ‰åº¦
            let rarity = 'N';
            const rand = Math.random();

            if (globalPity.sqr >= 160) {
                rarity = 'SQR';
            } else if (globalPity.sr >= 80) {
                rarity = 'SR';
            } else {
                if (rand < 0.025) rarity = 'SQR';
                else if (rand < 0.10) rarity = 'SR';
                else if (rand < 0.40) rarity = 'R';
            }

            if (minRarity === 'R' && rarity === 'N') rarity = 'R';

            // 3. é‡ç½®ä¿åº• (è§¸ç™¼ä¿åº•æˆ–é‹æ°£å¥½æŠ½åˆ°æ™‚é‡ç½®)
            if (rarity === 'SQR') globalPity.sqr = 0;
            if (rarity === 'SR') globalPity.sr = 0; 
            if (rarity === 'SQR') globalPity.sr = 0; // æŠ½åˆ° SQR é€šå¸¸ä¹Ÿæœƒé‡ç½® SR è¨ˆæ•¸
            
            localStorage.setItem('jlpt_n5_global_pity', JSON.stringify(globalPity));

            // 4. ç¯©é¸å¡æ± 
            let poolList = photoDB.filter(p => {
                if (p.rarity !== rarity) return false;
                if (poolType === 'duo') return p.character.includes('&');
                if (poolType === 'cheng') return p.character.includes('ç¨‹') && !p.character.includes('&');
                if (poolType === 'lu') return p.character.includes('é™¸') && !p.character.includes('&');
                return false;
            });
            // è©²æ± è©²ç¨€æœ‰åº¦æ²’å¡ï¼Œå›é€€åˆ°å…¨æ± 
            if (poolList.length === 0) poolList = photoDB.filter(p => p.rarity === rarity);

            // 5. æŠ½å–èˆ‡é˜²é‡è¦†
            const noDupe = document.getElementById('gacha-config').dataset.noDuplicate === 'Y';
            let winCard = null;

            if (noDupe) {
                const unowned = poolList.filter(p => !collectedPhotos[p.id]);
                if (unowned.length > 0) winCard = unowned[Math.floor(Math.random() * unowned.length)];
            }
            if (!winCard) winCard = poolList[Math.floor(Math.random() * poolList.length)];

            // 6. å¯«å…¥è³‡æ–™åº« (é‡è¦ä¿®å¾©)
            if (!collectedPhotos[winCard.id]) collectedPhotos[winCard.id] = 0;
            collectedPhotos[winCard.id]++;
            localStorage.setItem('jlpt_n5_collection', JSON.stringify(collectedPhotos));

            winCard.isNew = (collectedPhotos[winCard.id] === 1);
            return winCard;
        }

        function displayPullResult(card, container) {
            const div = document.createElement('div');
            div.className = 'mini-card';
            let borderColor = '#9ca3af'; // N
            if(card.rarity=='R') borderColor='#3b82f6';
            if(card.rarity=='SR') borderColor='#eab308';
            if(card.rarity=='SQR') borderColor='#ffd700';
            
            div.style.borderColor = borderColor;
            div.innerHTML = `
                <img src="${card.path}" style="width:100%; height:100%; object-fit:cover;">
                <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.7); font-size:0.6rem; color:white;">${card.rarity}</div>
                ${card.isNew ? '<div class="mini-new-badge">NEW</div>' : ''}
            `;
            container.appendChild(div);
        }

        // --- æ¸¬é©—èˆ‡å…¶ä»–åŠŸèƒ½ (ç¶­æŒåŸæ¨£) ---
        function startQuiz() {
            if(allQuestions.length===0 && tempSelectedCategory!=='ALL') return alert("ç„¡é¡Œç›®");
            document.getElementById('dashboard').classList.add('hidden'); document.getElementById('quiz-screen').classList.remove('hidden');
            const hd=document.getElementById('hearts-container'); const sd=document.getElementById('score-display'); const td=document.getElementById('timer-display');
            if(isChallengeMode) { hd.style.display='block'; hd.innerText="â¤".repeat(currentHearts); sd.style.display='none'; td.style.display=isTimerMode?'block':'none'; }
            else { hd.style.display='none'; td.style.display='none'; sd.style.display='inline'; }
            let f=tempSelectedCategory==='ALL'?allQuestions:allQuestions.filter(q=>q.section===tempSelectedCategory);
            if(f.length===0) f=allQuestions;
            quizList=f.sort(()=>Math.random()-0.5).slice(0,Math.min(tempSelectedCount,f.length));
            currentIdx=0; score=0; isGameOver=false; pendingHeal=false; showQuestion();
        }
        function showQuestion() {
            if(timerInterval) clearInterval(timerInterval);
            const q=quizList[currentIdx];
            document.getElementById('q-progress').innerText=`Q.${currentIdx+1}/${quizList.length}`;
            document.getElementById('score-display').innerText = "SCORE:" + score;
            document.getElementById('q-category-tag').innerText=q.section;
            document.getElementById('q-db-id').innerText=q.id;
            document.getElementById('q-text').innerHTML=q.question;
            document.getElementById('next-btn').style.display='none';
            document.getElementById('exp-box').style.display='none';
            document.getElementById('copy-msg').style.display='none';
            document.getElementById('hearts-container').classList.remove('shake-anim','heal-anim');
            const btnBug=document.getElementById('btn-report-bug'); btnBug.innerHTML="âš  é¡Œç›®ç•°å¸¸"; btnBug.classList.remove('disabled');
            const c=document.getElementById('options-container'); c.innerHTML='';
            let ops=q.options.map((t,i)=>({t:t,ok:(i===q.answer)})).sort(()=>Math.random()-0.5);
            ops.forEach(o=>{
                const b=document.createElement('button'); b.className='option-btn'; b.innerText=o.t;
                if(o.ok) b.dataset.correct="true";
                b.onclick=function(){checkAnswer(this,false)}; c.appendChild(b);
            });
            if(isTimerMode) startTimer();
        }
        function startTimer() {
            timeLeft=timeLimit; document.getElementById('timer-display').innerText=`â³ ${timeLeft}s`;
            timerInterval=setInterval(()=>{
                timeLeft--; document.getElementById('timer-display').innerText=`â³ ${timeLeft}s`;
                if(timeLeft<=0) { clearInterval(timerInterval); checkAnswer(null,true); }
            },1000);
        }
        function checkAnswer(btn, timeout) {
            if(timerInterval) clearInterval(timerInterval);
            document.querySelectorAll('.option-btn').forEach(b=>b.style.pointerEvents='none');
            const q=quizList[currentIdx];
            let right=false; if(!timeout && btn) right=(btn.dataset.correct==="true");
            if(right) {
                if(btn) btn.classList.add('correct'); score++;
                if(!isChallengeMode) confetti({particleCount:30,origin:{y:0.7}});
                if(wrongQuestions.includes(q.id)) { wrongQuestions=wrongQuestions.filter(id=>id!==q.id); localStorage.setItem('jlpt_n5_wrong_list',JSON.stringify(wrongQuestions)); }
                if(isChallengeMode && pendingHeal) { if(currentHearts<maxHearts) { currentHearts++; document.getElementById('hearts-container').innerText="â¤".repeat(currentHearts); document.getElementById('hearts-container').classList.add('heal-anim'); } pendingHeal=false; }
                userStats.correct++; userStats.streak++;
            } else {
                if(btn) btn.classList.add('wrong');
                document.querySelectorAll('.option-btn').forEach(b=>{if(b.dataset.correct==="true")b.classList.add('correct')});
                if(!wrongQuestions.includes(q.id)) { wrongQuestions.push(q.id); localStorage.setItem('jlpt_n5_wrong_list',JSON.stringify(wrongQuestions)); }
                userStats.streak=0; pendingHeal=false;
                if(isChallengeMode) {
                    currentHearts--; document.getElementById('hearts-container').innerText="â¤".repeat(currentHearts); document.getElementById('hearts-container').classList.add('shake-anim');
                    if(currentHearts<=0) isGameOver=true;
                }
            }
            userStats.total++; localStorage.setItem('jlpt_n5_stats_v18', JSON.stringify(userStats));
            document.getElementById('exp-box').style.display='block';
            document.getElementById('static-exp-text').innerHTML=q.explanation||"ç„¡è§£æ";
            const nb=document.getElementById('next-btn'); nb.style.display='block';
            nb.innerText=(isGameOver||currentIdx===quizList.length-1)?"æŸ¥çœ‹å ±å‘Š":"ä¸‹ä¸€å¼µ â¯";
        }
        function nextQuestion() {
            if(isGameOver) { showResult(); return; }
            currentIdx++; if(currentIdx<quizList.length) showQuestion(); else showResult();
        }
        function showResult() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('reward-container').style.display = 'none';
            const fs=Math.round((score/quizList.length)*100);
            document.getElementById('final-score').innerText=fs;
            const failImg=document.getElementById('fail-img-wrapper');
            const title=document.getElementById('result-title');
            const fbText=document.getElementById('feedback-text');
            const scoreCircle=document.getElementById('final-score');
            let earnedShards=0;
            if(score>0){
                let base=score*5; let multiplier=1;
                if(isChallengeMode){
                    multiplier*=(6-maxHearts)*1.1;
                    if(isTimerMode){ if(timeLimit===5)multiplier*=2; else if(timeLimit===12)multiplier*=1.5; else if(timeLimit===20)multiplier*=1.1; }
                }
                earnedShards=Math.ceil(base*multiplier);
            }
            if(isChallengeMode && isGameOver) {
                failImg.style.display='block';
                title.innerText="MISSION FAILED"; title.style.color="#ef4444"; scoreCircle.style.borderColor="#ef4444";
                fbText.innerText=`åŒæ­¥ç‡æ­¸é›¶ã€‚\næœ¬æ¬¡ç²å¾— 0 ç¢ç‰‡ã€‚`;
            } else {
                failImg.style.display='none';
                title.innerText="MISSION COMPLETE"; title.style.color="white"; scoreCircle.style.borderColor="#2d8cf0";
                userShards+=earnedShards; localStorage.setItem('jlpt_n5_shards',userShards);
                updateDashboard();
                fbText.innerHTML=`å§”è¨—å®Œæˆã€‚<br>ç²å¾— <span style="color:#ffd700; font-weight:bold;">ğŸ’  ${earnedShards}</span> æ™‚å…‰ç¢ç‰‡`;
            }
        }
        function openSetup(cat) { tempSelectedCategory=cat; document.getElementById('setup-modal').style.display='flex'; document.getElementById('challenge-toggle').checked=false; toggleChallengeMode(); }
        function closeSetup() { document.getElementById('setup-modal').style.display='none'; }
        function selectCount(n,b) { tempSelectedCount=n; document.querySelectorAll('.count-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }
        function toggleChallengeMode() { const chk=document.getElementById('challenge-toggle').checked; document.getElementById('heart-setting').style.display=chk?'block':'none'; if(!chk) { document.getElementById('timer-toggle').checked=false; toggleTimerMode(); } }
        function toggleTimerMode() { const chk=document.getElementById('timer-toggle').checked; document.getElementById('timer-setting').style.display=chk?'block':'none'; }
        function confirmStart() {
            isChallengeMode=document.getElementById('challenge-toggle').checked; isTimerMode=false;
            if(isChallengeMode) { maxHearts=parseInt(document.getElementById('heart-count').value); currentHearts=maxHearts; if(document.getElementById('timer-toggle').checked) { isTimerMode=true; timeLimit=parseInt(document.getElementById('time-limit').value); } }
            closeSetup(); startQuiz();
        }
        function openGallery() { document.getElementById('dashboard').classList.add('hidden'); document.getElementById('gallery-screen').classList.remove('hidden'); renderGallery(); }
        function closeGallery() { document.getElementById('dashboard').classList.remove('hidden'); document.getElementById('gallery-screen').classList.add('hidden'); }
        function renderGallery() { 
            const c=document.getElementById('gallery-content'); c.innerHTML='';
            const sort=document.getElementById('gallery-sort').value;
            const cc=Array.from(document.querySelectorAll('#filter-chars input:checked')).map(x=>x.value);
            const rc=Array.from(document.querySelectorAll('#filter-ranks input:checked')).map(x=>x.value);
            let f=photoDB.filter(p=>{ const cm=cc.some(c=>p.character.includes(c)||(c==="ç¨‹å°æ™‚&é™¸å…‰"&&p.character.includes("&"))); const rm=rc.includes(p.rarity); return cm&&rm; });
            let grp={}; f.forEach(p=>{ let k=sort==='char'?(p.character.includes("&")?"ç¨‹å°æ™‚&é™¸å…‰":p.character.includes("ç¨‹")?"ç¨‹å°æ™‚":p.character.includes("é™¸")?"é™¸å…‰":"å…¶ä»–"):p.rarity; if(!grp[k]) grp[k]=[]; grp[k].push(p); });
            const co=["ç¨‹å°æ™‚&é™¸å…‰","ç¨‹å°æ™‚","é™¸å…‰"]; const ro=["SQR","SR","R","N"];
            let sk=Object.keys(grp).sort((a,b)=>sort==='char'?(co.indexOf(a)-co.indexOf(b)):(ro.indexOf(a)-ro.indexOf(b)));
            sk.forEach(k=>{
                const t=document.createElement('div'); t.className='group-title'; t.innerText=k; c.appendChild(t);
                const g=document.createElement('div'); g.className='gallery-grid';
                grp[k].forEach(p=>{
                    const count = collectedPhotos[p.id] || 0; const own = count > 0;
                    const d=document.createElement('div'); d.className=`photo-card border-${p.rarity}`; d.onclick=()=>{if(own)openLightbox(p)};
                    d.innerHTML=`${own?`<img src="${p.path}" class="photo-img">`:`<div style="height:100%;background:#111;display:flex;justify-content:center;align-items:center;">ğŸ”’</div>`}<div class="photo-overlay">${own?p.title:"???"}</div>${own ? `<div class="qty-badge">x${count}</div>` : ''}`;
                    g.appendChild(d);
                });
                c.appendChild(g);
            });
        }
        function openLightbox(p){document.getElementById('lightbox').style.display='flex';document.getElementById('lightbox-img').src=p.path;document.getElementById('lightbox-title').innerText=p.title;document.getElementById('lightbox-rarity').innerText=`[${p.rarity}] ${p.character}`;}
        function closeLightbox(){document.getElementById('lightbox').style.display='none';}
        function openDarkroom() { if(wrongQuestions.length==0) return alert("æš—æˆ¿æ˜¯ç©ºçš„"); quizList=allQuestions.filter(q=>wrongQuestions.includes(q.id)).sort(()=>Math.random()-0.5); document.getElementById('dashboard').classList.add('hidden'); document.getElementById('quiz-screen').classList.remove('hidden'); currentIdx=0;score=0;isChallengeMode=false; showQuestion(); }
        function openReportCenter() {
            const c = document.getElementById('report-list-container'); c.innerHTML='';
            if(reportList.length==0) c.innerHTML='<div style="color:#aaa;padding:10px;">ç„¡å›å ±ç´€éŒ„</div>';
            else reportList.forEach(i=>{ const fullQ=allQuestions.find(q=>q.id==i.id)||{question:"æœªçŸ¥é¡Œç›®"}; const div=document.createElement('div'); div.className='report-item'; div.innerHTML=`<input type="checkbox" class="report-check" value="${i.id}"><div><div class="report-id">ID:${i.id}</div><div style="font-size:0.8rem;color:#cbd5e1;">${fullQ.question.substring(0,20)}...</div></div>`; c.appendChild(div); });
            document.getElementById('report-modal').style.display='flex';
        }
        function closeReportCenter() { document.getElementById('report-modal').style.display='none'; }
        function toggleSelectAllReports() { document.querySelectorAll('.report-check').forEach(c=>c.checked=!c.checked); }
        function resolveReports() { const ids=Array.from(document.querySelectorAll('.report-check:checked')).map(c=>parseInt(c.value)); if(ids.length==0) return alert("æœªå‹¾é¸"); reportList=reportList.filter(i=>!ids.includes(i.id)); localStorage.setItem('jlpt_n5_reports', JSON.stringify(reportList)); openReportCenter(); }
        function reportCurrentQuestion() { const q=quizList[currentIdx]; if(!reportList.some(i=>i.id===q.id)) { reportList.push({id:q.id}); localStorage.setItem('jlpt_n5_reports',JSON.stringify(reportList)); const btn=document.getElementById('btn-report-bug'); btn.innerHTML="âœ… å·²å›å ±"; btn.classList.add('disabled'); if(isChallengeMode) { pendingHeal=true; alert("å›å ±æˆåŠŸï¼ä¸‹ä¸€é¡Œç­”å°å¯å›è¡€ã€‚"); } else alert("å·²è¨˜éŒ„ID"); } }
        function resetStats(){if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ç´€éŒ„(å«ç›¸ç‰‡)å—?")){localStorage.clear();location.reload();}}
        function copyToClipboard() { const q = quizList[currentIdx]; let text = `é¡Œç›®ï¼š${q.question.replace(/<[^>]*>/g, '')}\né¸é …ï¼š\n`; q.options.forEach((opt, i) => { text += `${i+1}. ${opt}\n`; }); text += `\nè«‹è©³ç´°è§£æé€™é¡Œ N5 æ—¥æ–‡ã€‚`; navigator.clipboard.writeText(text).then(() => { const msg = document.getElementById('copy-msg'); msg.style.display = 'inline-block'; setTimeout(() => { msg.style.display = 'none'; }, 2000); }); }
        function copyId(){navigator.clipboard.writeText(document.getElementById('q-db-id').innerText);alert("IDå·²è¤‡è£½");}
        function closeGacha(){document.getElementById('gacha-overlay').style.display='none';document.getElementById('gacha-card-reveal').classList.remove('show');}
    </script>
</body>
</html>