<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ™‚å…‰ç…§ç›¸é¤¨ N5 å§”è¨—ç³»çµ± V18.6 (Fix)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --cheng-blue: #2d8cf0;
            --lu-white: #f8fafc;
            --dark-bg: #0f172a;
            --glass: rgba(15, 23, 42, 0.95);
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --border-n: #9ca3af;
            --border-r: #3b82f6;
            --border-sr: #eab308;
            --border-sqr: #000;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 0;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            background-image: url('link-click.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            color: white;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: -1;
        }

        .app-container {
            width: 100%;
            max-width: 600px;
            height: 100%;
            margin: 0 auto;
            position: relative;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: calc(10px + env(safe-area-inset-top)) 15px calc(20px + env(safe-area-inset-bottom)) 15px;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        /* å¡ç‰‡èˆ‡æŒ‰éˆ• */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.5s;
            position: relative;
            overflow: hidden;
        }

        .film-strip-top,
        .film-strip-bottom {
            position: absolute;
            left: 0;
            width: 100%;
            height: 15px;
            opacity: 0.5;
            background-image: linear-gradient(to right, transparent 50%, rgba(255, 255, 255, 0.3) 50%);
            background-size: 20px 100%;
        }

        .film-strip-top {
            top: 0;
        }

        .film-strip-bottom {
            bottom: 0;
        }

        .big-btn {
            background: var(--cheng-blue);
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .big-btn:hover {
            transform: translateY(-3px);
            background: #1a73e8;
        }

        .darkroom-btn {
            background: #333;
            border: 1px solid #555;
            color: #aaa;
        }

        .report-center-btn {
            background: #b45309;
        }

        .gallery-btn {
            background: linear-gradient(45deg, #7c3aed, #db2777);
            border: 1px solid #e879f9;
        }

        /* å„€è¡¨æ¿ */
        h1 {
            margin: 0;
            font-size: 1.8rem;
            text-shadow: 0 0 10px var(--cheng-blue);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-val {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--cheng-blue);
        }

        .stat-label {
            font-size: 0.7rem;
            color: #cbd5e1;
        }

        /* æš—æˆ¿çµ±è¨ˆå€å¡Š */
        .stat-box.darkroom-stat {
            border-color: rgba(239, 68, 68, 0.5);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: 0.2s;
        }

        .stat-box.darkroom-stat:hover {
            background: rgba(239, 68, 68, 0.15);
            transform: translateY(-2px);
            border-color: var(--danger);
        }

        .stat-box.darkroom-stat .stat-val {
            color: var(--danger);
        }

        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
            text-align: left;
        }

        .cat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
        }

        .cat-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--cheng-blue);
            transform: translateY(-2px);
        }

        /* åˆ—è¡¨æ¨£å¼ (æš—æˆ¿/å›å ±) */
        .list-container {
            max-height: 350px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 15px;
            text-align: left;
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 12px 10px;
            transition: 0.2s;
        }

        .list-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .darkroom-item {
            justify-content: space-between;
        }

        .darkroom-item .q-info {
            flex-grow: 1;
            padding-right: 10px;
        }

        .id-tag {
            color: var(--warning);
            font-weight: bold;
            font-family: monospace;
            font-size: 0.8rem;
            margin-right: 5px;
            background: rgba(245, 158, 11, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
        }

        .info-text {
            font-size: 0.9rem;
            color: #e2e8f0;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        /* ç¾åŒ–å¾Œçš„ä¿®å¾©æŒ‰éˆ• */
        .go-btn {
            background: transparent;
            color: var(--cheng-blue);
            padding: 6px 12px;
            border: 1px solid var(--cheng-blue);
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .go-btn:hover {
            background: var(--cheng-blue);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(45, 140, 240, 0.4);
        }

        /* è¨­å®šå½ˆçª— */
        .setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.98);
            z-index: 50;
            display: none;
            flex-direction: column;
            justify-content: center;
            padding: calc(30px + env(safe-area-inset-top)) 30px calc(30px + env(safe-area-inset-bottom)) 30px;
        }

        .count-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .count-btn {
            padding: 12px;
            border: 2px solid #334155;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #94a3b8;
        }

        .count-btn.active {
            border-color: var(--cheng-blue);
            color: var(--cheng-blue);
            background: rgba(45, 140, 240, 0.1);
        }

        .challenge-section {
            background: #1e293b;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }

        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--danger);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        /* Feedback Card Styles */
        .feedback-card {
            background: #0f172a;
            /* Dark background */
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            display: none;
            /* Hidden by default */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .feedback-header {
            margin-bottom: 10px;
        }

        .feedback-char-name {
            font-weight: bold;
            font-size: 1rem;
            color: white;
            margin-bottom: 4px;
        }

        .feedback-char-msg {
            font-size: 0.9rem;
            color: #cbd5e1;
        }

        .feedback-separator {
            border: 0;
            border-top: 1px dashed rgba(255, 255, 255, 0.2);
            margin: 10px 0;
        }

        .feedback-explanation {
            font-size: 0.9rem;
            color: #cbd5e1;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .feedback-actions {
            display: flex;
            gap: 10px;
        }

        .feedback-btn {
            flex: 1;
            border: none;
            border-radius: 6px;
            padding: 8px 0;
            font-weight: bold;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: opacity 0.2s;
        }

        .feedback-btn:hover {
            opacity: 0.9;
        }

        .btn-ask-ai {
            background: #3b82f6;
            /* Blue */
        }

        .btn-report {
            background: #f59e0b;
            /* Orange */
        }

        /* Adjust existing styles if needed */
        .character-dialog {
            display: none !important;
            /* Hide old dialog */
        }

        .setting-sub-box {
            margin-top: 10px;
            border-top: 1px dashed #475569;
            padding-top: 10px;
            display: none;
        }

        select {
            width: 100%;
            padding: 8px;
            background: #0f172a;
            color: white;
            border: 1px solid #475569;
            border-radius: 5px;
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .cat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }

        .cat-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            border-color: var(--cheng-blue);
        }

        /* ç•«å»Š */
        .gallery-header {
            margin-bottom: 15px;
        }

        .filter-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: left;
        }

        .filter-label {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 5px;
            display: block;
        }

        .checkbox-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .filter-chk {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .gallery-content {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 5px;
            text-align: left;
        }

        .group-title {
            color: var(--cheng-blue);
            font-size: 1.1rem;
            font-weight: bold;
            margin: 20px 0 10px 0;
            border-bottom: 1px solid rgba(45, 140, 240, 0.3);
            padding-bottom: 5px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
        }

        .photo-card {
            background: #0f172a;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            aspect-ratio: 3/4;
        }

        .photo-card:hover {
            transform: scale(1.05);
            z-index: 2;
        }

        .photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 3px;
            background: rgba(0, 0, 0, 0.7);
            font-size: 0.6rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .border-N {
            border: 2px solid var(--border-n);
        }

        .border-R {
            border: 2px solid var(--border-r);
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }

        .border-SR {
            border: 2px solid var(--border-sr);
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.6);
        }

        .border-SQR {
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px gold;
        }

        /* æ¸¬é©—ä»‹é¢ */
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .hearts-container {
            color: var(--danger);
            font-size: 1.2rem;
            text-shadow: 0 0 10px var(--danger);
        }

        .timer-display {
            font-family: monospace;
            font-size: 1.1rem;
            color: var(--warning);
            border: 1px solid var(--warning);
            padding: 2px 8px;
            border-radius: 4px;
            display: none;
        }

        .timer-display.urgent {
            color: var(--danger);
            border-color: var(--danger);
            animation: shake 0.5s infinite;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .q-tag {
            background: rgba(45, 140, 240, 0.2);
            color: var(--cheng-blue);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid var(--cheng-blue);
        }

        .id-badge {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #64748b;
            border: 1px solid #334155;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
        }

        .id-badge:hover {
            color: white;
            border-color: var(--cheng-blue);
            background: rgba(45, 140, 240, 0.1);
        }

        .question-text {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 10px 0 20px;
            line-height: 1.6;
            text-shadow: 1px 1px 2px black;
            user-select: text !important;
            cursor: text;
        }

        .option-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            color: #0f172a;
            border: none;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: left;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .option-btn:hover {
            background: white;
            transform: translateX(5px);
        }

        .option-btn.correct {
            background: #dcfce7;
            color: #166534;
            box-shadow: -5px 0 0 #166534;
        }

        .option-btn.wrong {
            background: #fee2e2;
            color: #991b1b;
            box-shadow: -5px 0 0 #991b1b;
        }

        /* å°è©±æ¡†èˆ‡å·¥å…· */
        .character-dialog {
            background: rgba(0, 0, 0, 0.6);
            border-left: 4px solid var(--cheng-blue);
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            border-radius: 0 10px 10px 0;
            display: none;
            animation: slideIn 0.3s;
        }

        .char-name {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        .char-text {
            font-size: 1rem;
            line-height: 1.5;
            color: #e2e8f0;
        }

        .cheng {
            border-color: var(--cheng-blue);
            color: #bfdbfe;
        }

        .lu {
            border-color: #94a3b8;
            color: #e2e8f0;
        }

        .tools-area {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .tool-btn {
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            transition: 0.2s;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tool-btn:active {
            transform: scale(0.95);
        }

        .btn-copy {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .btn-bug {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .btn-bug.disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        .exit-btn {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .exit-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* ç‡ˆç®±èˆ‡æŠ½å¡ */
        .lightbox-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .lightbox-img {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            border: 2px solid white;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
        }

        .gacha-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .gacha-card-reveal {
            width: 250px;
            height: 350px;
            background: #333;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.5s;
        }

        .gacha-card-reveal.show {
            opacity: 1;
            transform: scale(1);
        }

        .result-view {
            display: none;
            text-align: center;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid var(--cheng-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0 auto 20px;
            box-shadow: 0 0 20px var(--cheng-blue);
            background: rgba(0, 0, 0, 0.5);
        }

        .heal-anim {
            animation: heal 0.5s ease-in-out;
        }

        @keyframes heal {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.3);
                color: var(--success);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes shake {
            0% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            50% {
                transform: translateX(5px);
            }

            75% {
                transform: translateX(-5px);
            }

            100% {
                transform: translateX(0);
            }
        }

        .shard-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-sr);
            color: #ffd700;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-family: monospace;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 5;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .gacha-pool-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .pool-card {
            min-width: 120px;
            flex: 1;
            background: linear-gradient(180deg, #1e293b, #0f172a);
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 15px 5px;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .pool-card.active {
            border-color: var(--cheng-blue);
            background: rgba(45, 140, 240, 0.1);
            box-shadow: 0 0 15px rgba(45, 140, 240, 0.3);
        }

        .pool-title {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: white;
        }

        .pool-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .gacha-actions {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .btn-pull {
            background: linear-gradient(45deg, #2563eb, #1d4ed8);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            width: 48%;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .btn-pull:disabled {
            opacity: 0.5;
            filter: grayscale(1);
            cursor: not-allowed;
        }

        .btn-pull span {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .pull-result-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .mini-card {
            aspect-ratio: 3/4;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            border: 2px solid #555;
            animation: zoomIn 0.3s backwards;
        }

        .mini-new-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            font-size: 0.5rem;
            padding: 1px 3px;
        }

        .qty-badge {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.7rem;
            padding: 1px 6px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-family: monospace;
        }

        .beta-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: #64748b;
            border: 1px solid #334155;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: monospace;
            transition: 0.2s;
        }

        .beta-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .pity-counter-display {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.75rem;
            color: #f59e0b;
            display: inline-block;
            margin-top: 5px;
            border: 1px dashed #f59e0b;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(45, 140, 240, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: fadeOut 2.5s forwards;
            pointer-events: none;
        }

        @keyframes fadeOut {
            0% {
                opacity: 0;
                transform: translate(-50%, 20px);
            }

            10% {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            80% {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- ä¸»å„€è¡¨æ¿ -->
        <div id="dashboard" class="glass-card">
            <div class="shard-badge"><span>ğŸ’ </span> <span id="shard-count">0</span></div>
            <button class="beta-btn" onclick="activateBeta()">BETA</button>
            <div class="film-strip-top"></div>
            <h1>TIME PHOTO STUDIO</h1>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-val" id="stat-total">0</div>
                    <div class="stat-label">å®Œæˆå§”è¨—</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="stat-accuracy">0%</div>
                    <div class="stat-label">åŒæ­¥ç‡</div>
                </div>
                <!-- æš—æˆ¿ç•°å¸¸çµ±è¨ˆ (å¯é»æ“Š) -->
                <div class="stat-box darkroom-stat" onclick="openDarkroomList()">
                    <div class="stat-val" id="stat-wrong">0</div>
                    <div class="stat-label">æš—æˆ¿ç•°å¸¸</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="stat-streak" style="color:#f59e0b">0</div>
                    <div class="stat-label">é€£å‹</div>
                </div>
            </div>

            <div style="text-align:left; margin-bottom:10px; font-weight:bold; color:#cbd5e1;">ğŸ“‚ é¸æ“‡å§”è¨—é¡åˆ¥ï¼š</div>
            <div id="category-container" class="category-grid"></div>

            <button class="big-btn" onclick="openSetup('ALL')">âš¡ ç¶œåˆæ½›å…¥ (éš¨æ©Ÿ)</button>
            <button class="big-btn darkroom-btn" onclick="openDarkroom()">ğŸ“· é€²å…¥æš—æˆ¿ (éš¨æ©Ÿé‡ä¿®)</button>
            <button class="big-btn" style="background: linear-gradient(45deg, #8b5cf6, #d946ef);"
                onclick="openMockTestCenter()">ğŸ“… æ¨¡æ“¬å§”è¨—ä¸­å¿ƒ</button>
            <button class="big-btn" style="background: linear-gradient(45deg, #0ea5e9, #6366f1);"
                onclick="openGachaCenter()">ğŸ”® æ™‚å…‰æŠ½å¡ä¸­å¿ƒ</button>
            <button class="big-btn report-center-btn" onclick="openReportCenter()">âš  å•é¡Œå›å ±ä¸­å¿ƒ</button>
            <button class="big-btn gallery-btn" onclick="openGallery()">ğŸ–¼ï¸ å§”è¨—æˆå°±åº«</button>

            <div style="margin-top:20px; font-size:0.8rem; color:#64748b; cursor:pointer;" onclick="resetStats()">[
                é‡ç½®æ‰€æœ‰è¨˜éŒ„ ]</div>
            <div class="film-strip-bottom"></div>
        </div>

        <!-- ç•«å»Š -->
        <div id="gallery-screen" class="glass-card hidden">
            <div class="film-strip-top"></div>
            <div class="gallery-header">
                <h2>å§”è¨—æˆå°±</h2>
            </div>
            <div class="filter-section">
                <div class="filter-label">æ’åºæ–¹å¼ï¼š</div>
                <select id="gallery-sort"
                    style="margin-bottom:10px; width:100%; padding:5px; background:#0f172a; color:white;"
                    onchange="renderGallery()">
                    <option value="char">æŒ‰äººç‰©åˆ†çµ„</option>
                    <option value="rarity">æŒ‰ç¨€æœ‰åº¦åˆ†çµ„</option>
                </select>
                <div class="filter-label">äººç‰©ç¯©é¸ï¼š</div>
                <div class="checkbox-group" id="filter-chars">
                    <label class="filter-chk"><input type="checkbox" value="ç¨‹å°æ™‚&é™¸å…‰" checked onchange="renderGallery()">
                        é›™äºº</label>
                    <label class="filter-chk"><input type="checkbox" value="ç¨‹å°æ™‚" checked onchange="renderGallery()">
                        ç¨‹å°æ™‚</label>
                    <label class="filter-chk"><input type="checkbox" value="é™¸å…‰" checked onchange="renderGallery()">
                        é™¸å…‰</label>
                </div>
                <div class="filter-label" style="margin-top:5px;">ç­‰ç´šç¯©é¸ï¼š</div>
                <div class="checkbox-group" id="filter-ranks">
                    <label class="filter-chk"><input type="checkbox" value="N" checked onchange="renderGallery()">
                        N</label>
                    <label class="filter-chk"><input type="checkbox" value="R" checked onchange="renderGallery()">
                        R</label>
                    <label class="filter-chk"><input type="checkbox" value="SR" checked onchange="renderGallery()">
                        SR</label>
                    <label class="filter-chk"><input type="checkbox" value="SQR" checked onchange="renderGallery()">
                        SQR</label>
                </div>
            </div>
            <div id="gallery-content" class="gallery-content"></div>
            <button class="big-btn" style="margin-top:20px;" onclick="closeGallery()">è¿”å›ç¸½éƒ¨</button>
            <div class="film-strip-bottom"></div>
        </div>

        <!-- æ¨¡æ“¬å§”è¨—ä¸­å¿ƒ (Mock Test Center) -->
        <div id="mock-test-screen" class="glass-card hidden">
            <div class="film-strip-top"></div>
            <h2 style="color:#d946ef; margin-bottom:10px;">æ¨¡æ“¬å§”è¨—ä¸­å¿ƒ</h2>
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                <button class="tool-btn" id="btn-mock-n5" style="background:#3b82f6; width:100px;"
                    onclick="renderMockRounds('N5')">N5 å§”è¨—</button>
                <button class="tool-btn" id="btn-mock-n4" style="background:#eab308; width:100px;"
                    onclick="renderMockRounds('N4')">N4 å§”è¨—</button>
            </div>

            <div id="mock-list-container" style="height:50vh; overflow-y:auto; padding-right:5px;">
                <!-- Rounds will be rendered here -->
            </div>

            <button class="big-btn" style="margin-top:20px; background:#475569;"
                onclick="closeMockTestCenter()">è¿”å›ç¸½éƒ¨</button>
            <div class="film-strip-bottom"></div>
        </div>

        <!-- æ¨¡æ“¬å§”è¨—å ±å‘Š (Mock Result) -->
        <div id="mock-result-screen" class="glass-card hidden">
            <div class="film-strip-top"></div>
            <h2 style="color:#fbbf24;">å§”è¨—åŸ·è¡Œå ±å‘Š</h2>

            <div class="score-circle" id="mock-final-score" style="border-color:#d946ef; box-shadow: 0 0 20px #d946ef;">
                100</div>

            <div id="mock-breakdown"
                style="background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; margin-bottom:20px; text-align:left;">
                <!-- Breakdown goes here -->
            </div>

            <div id="mock-char-msg"
                style="margin-bottom:20px; font-style:italic; color:#cbd5e1; padding:10px; border-left:3px solid #d946ef; background:rgba(255,255,255,0.05);">
                <!-- Character message -->
            </div>

            <div style="color:#fbbf24; font-weight:bold; margin-bottom:20px;">
                ç²å¾—å ±é…¬ï¼šğŸ’  <span id="mock-reward-display">0</span>
            </div>

            <button class="big-btn" onclick="closeMockResult()">ç¢ºèªæ­¸æª”</button>
            <div class="film-strip-bottom"></div>
        </div>

        <!-- æŠ½å¡ä¸­å¿ƒä»‹é¢ -->
        <div id="gacha-screen" class="glass-card hidden">
            <div id="gacha-config" data-no-duplicate="Y" style="display:none;"></div>
            <div class="film-strip-top"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">æ™‚å…‰ç¯€é»</h2>
                <div
                    style="background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:15px; color:#ffd700; font-weight:bold;">
                    ğŸ’  <span id="gacha-shard-display">0</span>
                </div>
            </div>
            <div id="gacha-pool-container" class="gacha-pool-container">
                <!-- Pools will be rendered here dynamically -->
            </div>
            <div class="gacha-actions">
                <div id="pool-desc" style="margin-bottom:5px; color:#94a3b8; font-size:0.9rem;">N:60% | R:30% | SR:7.5%
                    | SQR:2.5%</div>
                <div id="pity-display" class="pity-counter-display">ç´¯ç©æŠ½æ•¸: 0</div>
                <div style="display:flex; justify-content:space-between; margin-top:15px;">
                    <button class="btn-pull" onclick="executePull(1)">æŠ½å– 1 æ¬¡<span>ğŸ’  100</span></button>
                    <button class="btn-pull" onclick="executePull(10)">æŠ½å– 10 æ¬¡<span>ğŸ’  1000 (ä¿åº•R)</span></button>
                </div>
            </div>
            <div id="pull-results" class="pull-result-grid"></div>
            <button class="big-btn" style="margin-top:20px; background:#475569;"
                onclick="closeGachaCenter()">è¿”å›ç¸½éƒ¨</button>
            <div class="film-strip-bottom"></div>
        </div>

        <!-- è¨­å®šå½ˆçª— -->
        <div id="setup-modal" class="setup-modal">
            <h2 style="color:white; margin-bottom:5px;">ä»»å‹™åƒæ•¸</h2>

            <!-- æ–°å¢ï¼šå¤šé¸é¡åˆ¥å€å¡Š (é è¨­éš±è—ï¼Œåªæœ‰é¸ ALL æ™‚é¡¯ç¤º) -->
            <div id="category-selection-area"
                style="display:none; margin-bottom:15px; background:#1e293b; padding:10px; border-radius:8px; border:1px solid #334155;">
                <div style="font-size:0.9rem; color:#cbd5e1; margin-bottom:5px;">ğŸ¯ é¸æ“‡ç·´ç¿’ç¯„åœï¼š</div>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="tool-btn" style="background:#3b82f6; font-size:0.8rem; padding:5px 8px;"
                        onclick="selectSubset('N5')">å…¨ N5</button>
                    <button class="tool-btn" style="background:#eab308; font-size:0.8rem; padding:5px 8px;"
                        onclick="selectSubset('N4')">å…¨ N4</button>
                    <button class="tool-btn" style="background:#64748b; font-size:0.8rem; padding:5px 8px;"
                        onclick="selectSubset('ALL')">å…¨éƒ¨</button>
                </div>
                <div id="multi-select-container" class="checkbox-group" style="max-height:100px; overflow-y:auto;">
                </div>
            </div>

            <div style="margin-bottom:10px; color:#cbd5e1;">é¡Œæ•¸ï¼š</div>
            <div class="count-grid">
                <button class="count-btn active" onclick="selectCount(5, this)">5</button>
                <button class="count-btn" onclick="selectCount(10, this)">10</button>
                <button class="count-btn" onclick="selectCount(20, this)">20</button>
            </div>
            <div class="challenge-section">
                <div class="switch-row">
                    <span style="font-weight:bold; color:#ef4444;">ğŸ”¥ æŒ‘æˆ°æ¨¡å¼</span>
                    <label class="switch"><input type="checkbox" id="challenge-toggle"
                            onchange="toggleChallengeMode()"><span class="slider"></span></label>
                </div>
                <div id="heart-setting" class="setting-sub-box">
                    <label style="font-size:0.8rem; color:#94a3b8;">åˆå§‹è¡€é‡ï¼š</label>
                    <select id="heart-count">
                        <option value="1">1 â¤</option>
                        <option value="2">2 â¤</option>
                        <option value="3" selected>3 â¤</option>
                        <option value="4">4 â¤</option>
                        <option value="5">5 â¤</option>
                    </select>
                    <div class="switch-row"
                        style="margin-top:10px; border-top:1px dashed #334155; padding-top:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold; color:#f59e0b;">â³ é™æ™‚ç­”é¡Œ</span>
                        <label class="switch" style="width:40px; height:20px;"><input type="checkbox" id="timer-toggle"
                                onchange="toggleTimerMode()"><span class="slider"></span></label>
                    </div>
                    <div id="timer-setting" style="display:none; margin-top:5px;">
                        <select id="time-limit">
                            <option value="5">5s</option>
                            <option value="12" selected>12s</option>
                            <option value="20">20s</option>
                        </select>
                    </div>
                </div>
            </div>
            <button class="big-btn" onclick="confirmStart()">ğŸš€ DIVES</button>
            <div style="margin-top:20px; color:#64748b; cursor:pointer; text-align:center;" onclick="closeSetup()">å–æ¶ˆ
            </div>
        </div>

        <!-- æš—æˆ¿ç•°å¸¸æ¸…å–®å½ˆçª— -->
        <div id="darkroom-list-modal" class="setup-modal">
            <h2 style="color:var(--danger); margin-bottom:5px;">æš—æˆ¿ç•°å¸¸æª”æ¡ˆ</h2>
            <p style="color:#94a3b8; margin-bottom:20px; font-size:0.9rem;">æª¢æ¸¬åˆ°ä»¥ä¸‹ç…§ç‰‡å­˜åœ¨åŒæ­¥åå·®ï¼Œè«‹é»æ“Šä¿®å¾©ã€‚</p>
            <div id="darkroom-list-container" class="list-container"></div>
            <div style="margin-top:20px; color:#64748b; cursor:pointer; text-align:center;"
                onclick="closeDarkroomList()">è¿”å›ç¸½éƒ¨</div>
        </div>

        <!-- å›å ±ä¸­å¿ƒ -->
        <div id="report-modal" class="setup-modal">
            <h2 style="color:var(--warning); margin-bottom:5px;">å•é¡Œå›å ±ä¸­å¿ƒ</h2>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button
                    style="background:#334155; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;"
                    onclick="toggleSelectAllReports()">å…¨é¸/å–æ¶ˆ</button>
            </div>
            <div id="report-list-container" class="list-container"></div>
            <button class="big-btn" style="background:var(--success);" onclick="resolveReports()">âœ… æ¨™è¨˜ç‚ºå·²è™•ç†</button>
            <div style="margin-top:20px; color:#64748b; cursor:pointer; text-align:center;"
                onclick="closeReportCenter()">é—œé–‰</div>
        </div>

        <!-- é¡Œç›®é è¦½å½ˆçª— (æ–°å¢) -->
        <div id="report-preview-modal" class="setup-modal" style="z-index: 2000;">
            <h2 style="color:var(--cheng-blue); margin-bottom:10px;">é¡Œç›®è©³æƒ…</h2>
            <div id="preview-content"
                style="background:#1e293b; padding:15px; border-radius:8px; text-align:left; max-height:60vh; overflow-y:auto;">
                <!-- JS will populate this -->
            </div>
            <div style="margin-top:20px; color:#64748b; cursor:pointer; text-align:center;"
                onclick="closeReportPreview()">é—œé–‰</div>
        </div>

        <!-- Beta é–‹ç™¼è€…æ§åˆ¶å° (æ–°å¢) -->
        <div id="beta-modal" class="setup-modal">
            <h2 style="color:#a855f7; margin-bottom:5px;">é–‹ç™¼è€…æ§åˆ¶å°</h2>
            <p style="color:#cbd5e1; font-size:0.9rem; margin-bottom:20px;">Developer Console</p>

            <div
                style="background:#1e293b; padding:20px; border-radius:12px; border:1px solid #475569; text-align:left;">

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <button class="big-btn" style="font-size:1rem; padding:15px;" onclick="openBetaQuestionViewer()">ğŸ“š
                        é¡Œåº«æª¢è¦–å™¨</button>
                    <button class="big-btn"
                        style="font-size:1rem; padding:15px; background:linear-gradient(45deg, #f59e0b, #d97706);"
                        onclick="openBetaGachaSettings()">âš™ æŠ½å¡åƒæ•¸</button>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="display:block; color:#cbd5e1; margin-bottom:5px;">è¨­å®šæ™‚å…‰ç¢ç‰‡æ•¸é‡</label>
                    <input type="number" id="beta-shard-input"
                        style="width:100%; padding:10px; background:#0f172a; border:1px solid #334155; color:white; border-radius:6px; font-size:1.1rem;"
                        placeholder="è¼¸å…¥æ•¸é‡">
                </div>

                <div class="switch-row" style="margin-top:20px; border-top:1px dashed #334155; padding-top:15px;">
                    <span style="font-weight:bold; color:#f59e0b;">ğŸ”“ è§£é–å…¨ç›¸ç‰‡åº«</span>
                    <label class="switch"><input type="checkbox" id="beta-unlock-toggle"><span
                            class="slider"></span></label>
                </div>
            </div>

            <button class="big-btn" style="background:linear-gradient(45deg, #7c3aed, #c026d3); margin-top:20px;"
                onclick="confirmBetaSettings()">ç¢ºèªåŸ·è¡Œ</button>
            <div style="margin-top:20px; color:#64748b; cursor:pointer; text-align:center;"
                onclick="closeBetaSettings()">å–æ¶ˆ</div>
        </div>

        <!-- Beta: é¡Œåº«æª¢è¦–å™¨ -->
        <div id="beta-question-viewer" class="glass-card hidden" style="z-index: 1500;">
            <div class="film-strip-top"></div>
            <h2 style="color:#a855f7;">é¡Œåº«æª¢è¦–å™¨</h2>
            <div style="margin-bottom:15px; display:flex; gap:10px;">
                <select id="beta-q-filter"
                    style="flex:1; padding:10px; background:#1e293b; color:white; border:1px solid #475569; border-radius:6px;"
                    onchange="renderBetaQuestions()">
                    <option value="ALL">å…¨éƒ¨é¡åˆ¥</option>
                </select>
                <div style="color:#cbd5e1; align-self:center;" id="beta-q-count">0 é¡Œ</div>
            </div>
            <div id="beta-q-list"
                style="height:60vh; overflow-y:auto; background:rgba(0,0,0,0.3); border-radius:8px; padding:10px;">
                <!-- Questions go here -->
            </div>
            <button class="big-btn" style="margin-top:20px;" onclick="closeBetaQuestionViewer()">è¿”å›æ§åˆ¶å°</button>
            <div class="film-strip-bottom"></div>
        </div>

        <!-- Beta: æŠ½å¡åƒæ•¸è¨­å®š (Advanced) -->
        <div id="beta-gacha-settings" class="setup-modal" style="z-index: 1600;">
            <h2 style="color:#f59e0b; margin-bottom:10px;">é«˜ç´šæŠ½å¡åƒæ•¸</h2>
            <div style="max-height:70vh; overflow-y:auto; padding-right:5px; text-align:left;">

                <!-- 1. åŸºç¤è¨­å®š -->
                <div class="setting-section"
                    style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-bottom:10px;">
                    <h3 style="color:#cbd5e1; font-size:1rem; margin-bottom:5px; border-bottom:1px solid #475569;">åŸºç¤è¨­å®š
                    </h3>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <label>å–®æŠ½åƒ¹æ ¼</label>
                        <input type="number" id="cfg-cost" class="beta-input" style="width:80px;" value="100">
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <label>åæŠ½ä¿åº•</label>
                        <select id="cfg-g10" class="beta-input" style="width:80px;">
                            <option value="N">ç„¡</option>
                            <option value="R">R</option>
                            <option value="SR">SR</option>
                            <option value="SQR">SQR</option>
                        </select>
                    </div>
                    <div class="switch-row">
                        <span>åªæŠ½æœªæ“æœ‰ (No Duplicate)</span>
                        <label class="switch"><input type="checkbox" id="cfg-no-dupe"><span
                                class="slider"></span></label>
                    </div>
                </div>

                <!-- 2. ç¨€æœ‰åº¦æ©Ÿç‡ -->
                <div class="setting-section"
                    style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-bottom:10px;">
                    <h3 style="color:#cbd5e1; font-size:1rem; margin-bottom:5px; border-bottom:1px solid #475569;">ç¨€æœ‰åº¦æ©Ÿç‡
                        (%)</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                        <div>
                            <label style="font-size:0.8rem;">R</label>
                            <input type="number" id="cfg-prob-r" class="beta-input" style="width:100%;" step="0.1">
                        </div>
                        <div>
                            <label style="font-size:0.8rem;">SR</label>
                            <input type="number" id="cfg-prob-sr" class="beta-input" style="width:100%;" step="0.1">
                        </div>
                        <div>
                            <label style="font-size:0.8rem;">SQR</label>
                            <input type="number" id="cfg-prob-sqr" class="beta-input" style="width:100%;" step="0.1">
                        </div>
                    </div>
                    <div id="prob-total-display"
                        style="font-size:0.8rem; color:#94a3b8; text-align:right; margin-top:5px;">Total: 0% (N: 100%)
                    </div>
                </div>

                <!-- 3. å¡æ± ç®¡ç† -->
                <div class="setting-section"
                    style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-bottom:10px;">
                    <h3 style="color:#cbd5e1; font-size:1rem; margin-bottom:5px; border-bottom:1px solid #475569;">å¡æ± ç®¡ç†
                    </h3>
                    <div id="pool-config-container">
                        <!-- Dynamic Pool Configs -->
                    </div>
                </div>

                <!-- 4. ä¿åº•ç³»çµ± -->
                <div class="setting-section"
                    style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-bottom:10px;">
                    <h3 style="color:#cbd5e1; font-size:1rem; margin-bottom:5px; border-bottom:1px solid #475569;">é€²éšä¿åº•
                    </h3>
                    <div class="switch-row" style="margin-bottom:5px;">
                        <span>å…±ç”¨ä¿åº• (Shared Pity)</span>
                        <label class="switch"><input type="checkbox" id="cfg-pity-shared"><span
                                class="slider"></span></label>
                    </div>
                    <div style="margin-bottom:5px;">
                        <label>æŒ‡å®šä¿åº•ç›®æ¨™ (Target)</label>
                        <div style="display:flex; gap:5px;">
                            <select id="cfg-target-type" class="beta-input" style="width:80px;">
                                <option value="rarity">ç¨€æœ‰åº¦</option>
                                <option value="char">äººç‰©</option>
                                <option value="photo">ID</option>
                            </select>
                            <input type="text" id="cfg-target-val" class="beta-input" style="flex:1;"
                                placeholder="SQR / Cheng / p001">
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label>è§¸ç™¼æŠ½æ•¸</label>
                        <input type="number" id="cfg-target-count" class="beta-input" style="width:80px;" value="160">
                    </div>
                </div>

            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="big-btn" style="background:#475569;" onclick="closeBetaGachaSettings()">å–æ¶ˆ</button>
                <button class="big-btn" onclick="saveAdvancedGachaConfig()">å„²å­˜è¨­å®š</button>
            </div>
        </div>

        <!-- æ¸¬é©—ä»‹é¢ -->
        <div id="quiz-screen" class="glass-card hidden">
            <div class="film-strip-top"></div>
            <div class="quiz-header">
                <div><span id="q-progress">Q.1</span> <span id="score-display" style="margin-left:10px;">SCORE:0</span>
                </div>
                <div style="display:flex; gap:10px; align-items: center;">
                    <div id="timer-display" class="timer-display">12s</div>
                    <div id="hearts-container" class="hearts-container" style="display:none;">â¤â¤â¤</div>
                </div>
            </div>

            <div class="meta-row">
                <span class="q-tag" id="q-category-tag">æ–‡æ³•</span>
                <div style="display:flex; gap:10px; align-items:center;">
                    <span class="id-badge" onclick="copyId()">ID: <span id="q-db-id">--</span></span>
                    <button class="exit-btn" onclick="forceExit()">â›” é€€å‡º</button>
                </div>
            </div>

            <div class="question-text" id="q-text">Loading...</div>
            <div id="options-container"></div>

            <!-- Feedback Card (New Structure) -->
            <div id="feedback-card" class="feedback-card">
                <div class="feedback-header">
                    <div id="fb-char-name" class="feedback-char-name">ç¨‹å°æ™‚</div>
                    <div id="fb-char-msg" class="feedback-char-msg">...</div>
                </div>
                <hr class="feedback-separator">
                <div id="fb-explanation" class="feedback-explanation"></div>
                <div class="feedback-actions">
                    <button class="feedback-btn btn-ask-ai" onclick="copyToClipboard()">
                        <span>ğŸ¤–</span> å•AI
                    </button>
                    <button id="btn-report-bug" class="feedback-btn btn-report" onclick="reportCurrentQuestion()">
                        <span>âš </span> é¡Œç›®ç•°å¸¸
                    </button>
                </div>
            </div>

            <!-- Old elements hidden/removed via CSS/JS, but keeping structure clean -->
            <div id="char-dialog" style="display:none;"></div>
            <div id="exp-box" style="display:none;"></div>
            <span id="copy-msg" style="font-size:0.8rem; color:#22c55e; display:none; margin-left:10px;">å·²è¤‡è£½ï¼</span>

            <button class="big-btn" id="next-btn" style="margin-top:20px; display:none;" onclick="nextQuestion()">ä¸‹ä¸€å¼µ
                â¯</button>
            <div class="film-strip-bottom"></div>
        </div>

        <!-- çµæœç•«é¢ -->
        <div class="glass-card hidden" id="result-view">
            <div class="film-strip-top"></div>
            <h2 id="result-title">ä»»å‹™å ±å‘Š</h2>
            <div class="score-circle" id="final-score">100</div>

            <div id="fail-img-wrapper" style="display:none; margin-bottom:20px;">
                <img src="Fail_images.png" style="max-width:100%; border-radius:10px; border:2px solid #ef4444;">
            </div>

            <!-- çå‹µå±•ç¤º -->
            <div id="reward-container" style="display:none; margin-bottom:20px; animation: zoomIn 0.5s;">
                <div style="color:#fbbf24; font-weight:bold; margin-bottom:5px;">âœ¨ æœ¬æ¬¡å§”è¨—çå‹µ</div>
                <div id="reward-card-mini"
                    style="width:120px; height:160px; margin:0 auto; background:#333; border-radius:8px; overflow:hidden; border:2px solid white;">
                </div>
                <div id="reward-name" style="font-size:0.9rem; margin-top:5px; color:#cbd5e1;"></div>
            </div>

            <p id="feedback-text" style="color:#cbd5e1; margin-bottom:30px;">çµç®—ä¸­...</p>
            <button class="big-btn" onclick="location.reload()">è¿”å›ç¸½éƒ¨</button>
            <div class="film-strip-bottom"></div>
        </div>

        <!-- æŠ½å¡èˆ‡ç‡ˆç®± (ä¿æŒä¸è®Š) -->
        <div id="gacha-overlay" class="gacha-overlay">
            <div class="gacha-flash"></div>
            <div style="color:white; font-size:1.5rem; margin-bottom:20px; z-index:2;">âœ¨ ç²å¾—æ–°å§”è¨—ç…§ç‰‡ï¼</div>
            <div id="gacha-card-reveal" class="gacha-card-reveal"></div>
            <div id="gacha-info" style="color:white; margin-top:20px; font-size:1.2rem; font-weight:bold; z-index:2;">
            </div>
            <button class="big-btn" style="margin-top:30px; z-index:2; width:200px;" onclick="closeGacha()">æ”¶ä¸‹</button>
        </div>
        <div id="lightbox" class="lightbox-modal" onclick="closeLightbox()">
            <div class="lightbox-img-container" onclick="event.stopPropagation()">
                <img id="lightbox-img" class="lightbox-img" src="">
            </div>
            <div class="lightbox-info">
                <div id="lightbox-title" class="lightbox-title"></div>
                <div id="lightbox-rarity" class="lightbox-meta"></div>
            </div>
        </div>
    </div>

    <script>
        // Helper for safe parsing
        function safeJSONParse(str, fallback) {
            try {
                return str ? JSON.parse(str) : fallback;
            } catch (e) {
                console.warn("JSON Parse Error:", e);
                return fallback;
            }
        }

        // --- æ ¸å¿ƒè³‡æ–™èˆ‡è®Šæ•¸ V18.6 ---
        console.log("Script initializing...");
        let allQuestions = [], quizList = [], currentIdx = 0, score = 0;
        let tempSelectedCategory = 'ALL', tempSelectedCount = 5;
        let isChallengeMode = false, isTimerMode = false, timeLimit = 12, timerInterval = null, timeLeft = 0;
        let maxHearts = 3, currentHearts = 3, isGameOver = false, pendingHeal = false;

        const chengQuotes = ["é€™å¼µç…§ç‰‡æ²’å•é¡Œï¼", "é…åˆå®Œç¾ï¼", "Nice shot!", "æ™‚å…‰ç¯€é»ç¢ºèªã€‚", "å°±æ˜¯é€™å€‹æ™‚åˆ»ï¼"];
        const luQuotes = ["ä½ è¶Šç•Œäº†ã€‚", "ä»”ç´°çœ‹æ¸…æ¥šã€‚", "è«‹å‹¿å¹²æ¶‰éå»...ä½†é€™é¡ŒéŒ¯äº†ã€‚", "åŒæ­¥ç‡ä¸‹é™ã€‚", "å†·éœé»ï¼Œå†ä¾†ä¸€æ¬¡ã€‚"];

        // ä¿åº•é¡Œåº«
        const FALLBACK_QUESTIONS = [
            { id: 101, section: "N5-æ–‡æ³•", type: "åŠ©è©", question: "ã‚ãŸã—ã¯ã€€æ˜æ—¥ã€€å‹é”ï¼¿ï¼¿ï¼¿ä¼šã„ã¾ã™ã€‚", options: ["ã«", "ã‚’", "ã§", "ã¸"], answer: 0, explanation: "ã€æ­£è§£ï¼šã«ã€‘å‹•è©ã€Œä¼šã„ã¾ã™ã€çš„å°è±¡ç”¨ã€Œã«ã€ã€‚" },
            { id: 102, section: "N5-æ–‡æ³•", type: "å‹•è©", question: "æœ¬ã‚’ã€€ï¼¿ï¼¿ï¼¿ãã ã•ã„ã€‚", options: ["èª­ã‚€", "èª­ã‚“ã§", "èª­ã¿ã¦", "èª­ã‚“ã¦"], answer: 1, explanation: "ã€æ­£è§£ï¼šèª­ã‚“ã§ã€‘è«‹åšæŸäº‹ç”¨ã€Œã¦å½¢ã€ã€‚" },
            { id: 103, section: "N5-èªå½™", type: "åè©", question: "æœºã®ä¸Šã«ã€€<span style='text-decoration:underline'>é‰›ç­†</span>ã€€ãŒã‚ã‚Šã¾ã™ã€‚", options: ["ãˆã‚“ã³ã¤", "ãˆã‚“ã´ã¤", "ã¯ãª", "ã‹ã°ã‚“"], answer: 1, explanation: "ã€æ­£è§£ï¼šãˆã‚“ã´ã¤ã€‘é‰›ç­† = enpitsu" },
            { id: 104, section: "N5-æ–‡æ³•", type: "ç–‘å•è©", question: "èª•ç”Ÿæ—¥ã¯ã€€ï¼¿ï¼¿ï¼¿ã§ã™ã‹ã€‚", options: ["ã„ã¤", "ã©ã‚Œ", "ã ã‚Œ", "ã©ã†"], answer: 0, explanation: "ã€æ­£è§£ï¼šã„ã¤ã€‘å•æ™‚é–“ç”¨ã€Œã„ã¤ã€ã€‚" },
            { id: 105, section: "N5-è®€è§£", type: "çŸ­æ–‡", question: "ã€Œæ—¥æ›œæ—¥ã¯å›³æ›¸é¤¨ã«è¡Œãã¾ã›ã‚“ã€‚ã€<br>è³ªå•ï¼šæ—¥æ›œæ—¥ã¯ã©ã“ã«è¡Œãã¾ã™ã‹ã€‚", options: ["å›³æ›¸é¤¨", "å­¦æ ¡", "ã‚ã‹ã‚Šã¾ã›ã‚“", "ä¼šç¤¾"], answer: 2, explanation: "ã€æ­£è§£ï¼šã‚ã‹ã‚Šã¾ã›ã‚“ã€‘æ–‡ä¸­æœªæåŠè¦å»å“ªã€‚" }
        ];

        // ä¿åº•ç›¸ç‰‡
        const FALLBACK_PHOTOS = [
            { id: "p001", title: "åˆå§‹çš„å§”è¨—", character: "ç¨‹å°æ™‚&é™¸å…‰", rarity: "N", path: "https://via.placeholder.com/300x400/2d8cf0/ffffff?text=LINK+CLICK+N" },
            { id: "p002", title: "æ ¡åœ’è§’è½", character: "é™¸å…‰", rarity: "R", path: "https://via.placeholder.com/300x400/3b82f6/ffffff?text=LU+GUANG+R" },
            { id: "p003", title: "ç±ƒçƒå ´", character: "ç¨‹å°æ™‚", rarity: "SR", path: "https://via.placeholder.com/300x400/eab308/ffffff?text=CHENG+SR" }
        ];

        // æ•¸æ“šè®€å–
        let userStats = safeJSONParse(localStorage.getItem('jlpt_n5_stats_v18'), { total: 0, correct: 0, streak: 0 });
        let wrongQuestions = safeJSONParse(localStorage.getItem('jlpt_n5_wrong_list'), []);
        let reportList = safeJSONParse(localStorage.getItem('jlpt_n5_reports'), []);

        let collectedPhotos = {};
        let rawCollection = safeJSONParse(localStorage.getItem('jlpt_n5_collection'), null);
        let userShards = parseInt(localStorage.getItem('jlpt_n5_shards')) || 6000;
        let globalPity = safeJSONParse(localStorage.getItem('jlpt_n5_global_pity'), { sr: 0, sqr: 0 });

        if (Array.isArray(rawCollection)) {
            rawCollection.forEach(id => { collectedPhotos[id] = 1; });
            localStorage.setItem('jlpt_n5_collection', JSON.stringify(collectedPhotos));
        } else if (rawCollection) {
            collectedPhotos = rawCollection;
        }

        let photoDB = [];
        let currentPool = 'duo';

        // Mock Test Data
        let normalQuestionsDB = []; // For Normal Quiz & General Dive
        let mockQuestionsDB = { N4: [], N5: [] };
        let mockResults = safeJSONParse(localStorage.getItem('jlpt_mock_results'), {});
        let isMockMode = false;
        let currentMockBatch = null;
        let mockRewardMultiplier = 5; // Default reward per correct answer

        // Gacha Config (Default)
        let gachaConfig = {
            cost: 100,
            rarityProb: { N: 60, R: 30, SR: 7.5, SQR: 2.5 },
            pools: {
                duo: { active: true, name: "é›™äººæ­æª”", text: "ç¨‹å°æ™‚ & é™¸å…‰", charProb: { duo: 100, lu: 0, cheng: 0 } },
                cheng: { active: true, name: "ç¨‹å°æ™‚", text: "ç†±è¡€ç³»", charProb: { duo: 0, lu: 0, cheng: 100 } },
                lu: { active: true, name: "é™¸å…‰", text: "å†·éœç³»", charProb: { duo: 0, lu: 100, cheng: 0 } }
            },
            pity: { isShared: true, targetType: 'rarity', targetValue: 'SQR', targetCount: 160 },
            guaranteed10: 'R',
            noDuplicate: false
        };

        window.onload = async function () {
            try {
                console.log("Window onload started");
                loadGachaConfig();

                // Force render backup
                setTimeout(() => {
                    const container = document.getElementById('category-container');
                    if (container && container.innerHTML === '') {
                        console.warn("Force rendering categories due to timeout");
                        if (allQuestions.length === 0) allQuestions = FALLBACK_QUESTIONS;
                        if (photoDB.length === 0) photoDB = FALLBACK_PHOTOS;
                        renderCategories();
                        renderGachaPools();
                        updateDashboard();
                    }
                }, 2000);

                try {
                    await loadData();
                    console.log("Data loaded, questions:", allQuestions.length);
                } catch (e) { console.error("Data load error:", e); }

                try {
                    await loadPhotoDB();
                    console.log("Photos loaded:", photoDB.length);
                } catch (e) { console.error("Photo load error:", e); }

                renderCategories();
                renderGachaPools();
                updateDashboard();
            } catch (err) {
                console.error("Critical Error in window.onload:", err);
            }
        };

        function loadGachaConfig() {
            const saved = localStorage.getItem('jlpt_n5_gacha_config');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Merge deeply to ensure new fields exist
                    gachaConfig = { ...gachaConfig, ...parsed };
                    // Ensure nested objects exist if migrating from old version
                    if (!gachaConfig.rarityProb) gachaConfig.rarityProb = { N: 60, R: 30, SR: 7.5, SQR: 2.5 };
                    if (!gachaConfig.pools) gachaConfig.pools = {
                        duo: { active: true, name: "é›™äººæ­æª”", text: "ç¨‹å°æ™‚ & é™¸å…‰", charProb: { duo: 100, lu: 0, cheng: 0 } },
                        cheng: { active: true, name: "ç¨‹å°æ™‚", text: "ç†±è¡€ç³»", charProb: { duo: 0, lu: 0, cheng: 100 } },
                        lu: { active: true, name: "é™¸å…‰", text: "å†·éœç³»", charProb: { duo: 0, lu: 100, cheng: 0 } }
                    };
                    if (!gachaConfig.pity) gachaConfig.pity = { isShared: true, targetType: 'rarity', targetValue: 'SQR', targetCount: 160 };
                } catch (e) { console.error("Config load error", e); }
            }
        }

        async function loadData() {
            try {
                // 1. Load Normal Quiz Data (n5_questions.json)
                const normalRes = await fetch('n5_questions.json');
                if (normalRes.ok) {
                    normalQuestionsDB = await normalRes.json();
                } else {
                    console.error("Failed to load n5_questions.json");
                }

                // 2. Load Mock Test Data
                // Load N5
                const n5Res = await fetch('JLPT_n5_questions.json');
                if (n5Res.ok) {
                    mockQuestionsDB.N5 = await n5Res.json();
                }
                // Load N4
                const n4Res = await fetch('JLPT_n4_questions.json');
                if (n4Res.ok) {
                    mockQuestionsDB.N4 = await n4Res.json();
                }

                // Default allQuestions to Normal DB for dashboard rendering
                allQuestions = normalQuestionsDB.length > 0 ? normalQuestionsDB : FALLBACK_QUESTIONS;

            } catch (e) {
                console.warn("Data Load Error:", e);
                allQuestions = FALLBACK_QUESTIONS;
            }
        }

        async function loadPhotoDB() {
            try {
                const fetchPromise = fetch('photos.json').then(r => {
                    if (!r.ok) throw new Error();
                    return r.json();
                });
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 1000));

                photoDB = await Promise.race([fetchPromise, timeoutPromise]);
            } catch (e) {
                console.warn("Using Fallback Photos:", e);
                photoDB = FALLBACK_PHOTOS;
            }
        }

        // --- Beta é–‹ç™¼è€…åŠŸèƒ½ (V18.4 Enhanced) ---
        function activateBeta() {
            const code = prompt("ã€Beta é–‹ç™¼è€…æ¨¡å¼ã€‘\nè«‹è¼¸å…¥æš—è™Ÿï¼š");
            if (code === "SC&LG") {
                // é¡¯ç¤ºè¨­å®šå½ˆçª—ï¼Œè€Œä¸æ˜¯ç›´æ¥åŸ·è¡Œ
                document.getElementById('beta-shard-input').value = userShards;
                document.getElementById('beta-unlock-toggle').checked = false;
                document.getElementById('beta-modal').style.display = 'flex';
            } else {
                alert("â›” æš—è™ŸéŒ¯èª¤");
            }
        }

        function confirmBetaSettings() {
            // 1. è¨­å®šç¢ç‰‡
            const inputShards = parseInt(document.getElementById('beta-shard-input').value);
            if (!isNaN(inputShards) && inputShards >= 0) {
                userShards = inputShards;
                localStorage.setItem('jlpt_n5_shards', userShards);
            }

            // 2. è§£é–ç›¸ç‰‡
            const unlockAll = document.getElementById('beta-unlock-toggle').checked;
            if (unlockAll) {
                if (photoDB.length === 0) photoDB = FALLBACK_PHOTOS;
                photoDB.forEach(p => {
                    if (!collectedPhotos[p.id]) collectedPhotos[p.id] = 1;
                });
                localStorage.setItem('jlpt_n5_collection', JSON.stringify(collectedPhotos));
            }

            alert(`âœ¨ è¨­å®šå·²å¥—ç”¨ï¼\n- æ™‚å…‰ç¢ç‰‡: ${userShards}\n- å…¨ç›¸ç‰‡åº«: ${unlockAll ? "å·²è§£é–" : "ç¶­æŒåŸç‹€"}`);
            location.reload();
        }

        function closeBetaSettings() {
            document.getElementById('beta-modal').style.display = 'none';
        }

        // --- Beta Question Viewer ---
        function openBetaQuestionViewer() {
            document.getElementById('beta-modal').style.display = 'none';
            document.getElementById('beta-question-viewer').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden'); // Ensure dashboard is hidden
            renderBetaQuestions();
        }

        function closeBetaQuestionViewer() {
            document.getElementById('beta-question-viewer').classList.add('hidden');
            document.getElementById('beta-modal').style.display = 'flex';
        }

        function renderBetaQuestions() {
            const filter = document.getElementById('beta-q-filter').value;
            const list = document.getElementById('beta-q-list');
            list.innerHTML = '';

            // Populate filter if empty
            const filterSel = document.getElementById('beta-q-filter');
            if (filterSel.options.length === 1) {
                const sections = [...new Set(allQuestions.map(q => q.section))].sort();
                sections.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s; opt.innerText = s;
                    filterSel.appendChild(opt);
                });
            }

            let filtered = allQuestions;
            if (filter !== 'ALL') filtered = allQuestions.filter(q => q.section === filter);

            document.getElementById('beta-q-count').innerText = `${filtered.length} é¡Œ`;

            filtered.forEach(q => {
                const d = document.createElement('div');
                d.style.background = 'rgba(255,255,255,0.05)';
                d.style.marginBottom = '5px';
                d.style.padding = '8px';
                d.style.borderRadius = '4px';
                d.style.fontSize = '0.9rem';
                d.style.color = '#cbd5e1';
                d.innerHTML = `<span style="color:var(--cheng-blue); font-weight:bold;">[${q.section}]</span> ID:${q.id} <br> ${q.question.replace(/<[^>]+>/g, '')}`;
                list.appendChild(d);
            });
        }

        // --- Beta Gacha Settings ---
        function openBetaGachaSettings() {
            document.getElementById('beta-gacha-settings').style.display = 'flex';

            // 1. Basic
            document.getElementById('cfg-cost').value = gachaConfig.cost;
            document.getElementById('cfg-g10').value = gachaConfig.guaranteed10;
            document.getElementById('cfg-no-dupe').checked = gachaConfig.noDuplicate;

            // 2. Rarity Prob
            document.getElementById('cfg-prob-r').value = gachaConfig.rarityProb.R;
            document.getElementById('cfg-prob-sr').value = gachaConfig.rarityProb.SR;
            document.getElementById('cfg-prob-sqr').value = gachaConfig.rarityProb.SQR;
            updateProbTotal(); // Helper to calc N and Total

            // 3. Pools
            const poolContainer = document.getElementById('pool-config-container');
            poolContainer.innerHTML = '';
            for (const [key, pool] of Object.entries(gachaConfig.pools)) {
                const div = document.createElement('div');
                div.style.background = 'rgba(255,255,255,0.05)';
                div.style.padding = '5px';
                div.style.marginBottom = '5px';
                div.style.borderRadius = '4px';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <span style="color:#f59e0b;">${pool.name} (${key})</span>
                        <label class="switch" style="transform:scale(0.8);"><input type="checkbox" class="pool-active-chk" data-pool="${key}" ${pool.active ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <input type="text" class="beta-input pool-text-input" data-pool="${key}" value="${pool.text}" placeholder="è‡ªè¨‚æ–‡å­—" style="width:100%; margin-bottom:5px;">
                    <div style="display:flex; gap:5px;">
                        <input type="number" class="beta-input pool-prob-input" data-pool="${key}" data-char="duo" value="${pool.charProb.duo}" placeholder="Duo%" style="width:33%;">
                        <input type="number" class="beta-input pool-prob-input" data-pool="${key}" data-char="lu" value="${pool.charProb.lu}" placeholder="Lu%" style="width:33%;">
                        <input type="number" class="beta-input pool-prob-input" data-pool="${key}" data-char="cheng" value="${pool.charProb.cheng}" placeholder="Cheng%" style="width:33%;">
                    </div>
                `;
                poolContainer.appendChild(div);
            }

            // 4. Pity
            document.getElementById('cfg-pity-shared').checked = gachaConfig.pity.isShared;
            document.getElementById('cfg-target-type').value = gachaConfig.pity.targetType;
            document.getElementById('cfg-target-val').value = gachaConfig.pity.targetValue;
            document.getElementById('cfg-target-count').value = gachaConfig.pity.targetCount;

            // Add listeners for prob calculation
            ['cfg-prob-r', 'cfg-prob-sr', 'cfg-prob-sqr'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateProbTotal);
            });
        }

        function updateProbTotal() {
            const r = parseFloat(document.getElementById('cfg-prob-r').value) || 0;
            const sr = parseFloat(document.getElementById('cfg-prob-sr').value) || 0;
            const sqr = parseFloat(document.getElementById('cfg-prob-sqr').value) || 0;
            const total = r + sr + sqr;
            const n = Math.max(0, 100 - total);
            const display = document.getElementById('prob-total-display');
            if (display) {
                display.innerText = `Total: ${total.toFixed(1)}% (N: ${n.toFixed(1)}%)`;
                display.style.color = total > 100 ? '#ef4444' : '#94a3b8';
            }
        }

        function closeBetaGachaSettings() {
            document.getElementById('beta-gacha-settings').style.display = 'none';
            document.getElementById('beta-modal').style.display = 'flex';
        }

        function saveAdvancedGachaConfig() {
            // 1. Basic
            const cost = parseInt(document.getElementById('cfg-cost').value);
            const g10 = document.getElementById('cfg-g10').value;
            const noDupe = document.getElementById('cfg-no-dupe').checked;

            // 2. Rarity
            const r = parseFloat(document.getElementById('cfg-prob-r').value) || 0;
            const sr = parseFloat(document.getElementById('cfg-prob-sr').value) || 0;
            const sqr = parseFloat(document.getElementById('cfg-prob-sqr').value) || 0;
            if (r + sr + sqr > 100) {
                alert("ç¨€æœ‰åº¦æ©Ÿç‡ç¸½å’Œä¸èƒ½è¶…é 100%ï¼");
                return;
            }
            const n = 100 - (r + sr + sqr);

            // 3. Pools
            const pools = {};
            const poolContainer = document.getElementById('pool-config-container');
            // Reconstruct pools object from DOM inputs
            // We iterate over the original keys to preserve order/structure
            for (const key of Object.keys(gachaConfig.pools)) {
                const active = document.querySelector(`.pool-active-chk[data-pool="${key}"]`).checked;
                const text = document.querySelector(`.pool-text-input[data-pool="${key}"]`).value;
                const duo = parseFloat(document.querySelector(`.pool-prob-input[data-pool="${key}"][data-char="duo"]`).value) || 0;
                const lu = parseFloat(document.querySelector(`.pool-prob-input[data-pool="${key}"][data-char="lu"]`).value) || 0;
                const cheng = parseFloat(document.querySelector(`.pool-prob-input[data-pool="${key}"][data-char="cheng"]`).value) || 0;

                if (duo + lu + cheng !== 100) {
                    alert(`å¡æ±  ${key} çš„äººç‰©æ©Ÿç‡ç¸½å’Œå¿…é ˆç‚º 100%ï¼ç›®å‰: ${duo + lu + cheng}%`);
                    return;
                }

                pools[key] = {
                    active, name: gachaConfig.pools[key].name, text,
                    charProb: { duo, lu, cheng }
                };
            }

            // 4. Pity
            const isShared = document.getElementById('cfg-pity-shared').checked;
            const targetType = document.getElementById('cfg-target-type').value;
            const targetValue = document.getElementById('cfg-target-val').value;
            const targetCount = parseInt(document.getElementById('cfg-target-count').value);

            // Save
            gachaConfig = {
                cost,
                rarityProb: { N: n, R: r, SR: sr, SQR: sqr },
                pools,
                pity: { isShared, targetType, targetValue, targetCount },
                guaranteed10: g10,
                noDuplicate: noDupe
            };

            localStorage.setItem('jlpt_n5_gacha_config', JSON.stringify(gachaConfig));
            alert("è¨­å®šå·²å„²å­˜ï¼");
            closeBetaGachaSettings();
            renderGachaPools(); // Refresh UI
        }

        function renderCategories(level = null) {
            const container = document.getElementById('category-container');
            // ... (rest of function)
            // Note: Since I cannot see the rest of the function in the view, I will append the new functions after this block.
            // But wait, I need to make sure I don't break the existing renderCategories.
            // I will just append the new logic at the end of the script tag, but before the closing tag.
            // Actually, I'll insert the new functions before renderCategories to be safe, or just append to the end of the file.
            // Let's replace the end of the script.
        }

        // --- Mock Test Logic ---

        function openMockTestCenter() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('mock-test-screen').classList.remove('hidden');
            renderMockRounds('N5'); // Default to N5
        }

        function closeMockTestCenter() {
            document.getElementById('mock-test-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function renderMockRounds(level) {
            // Update buttons
            document.getElementById('btn-mock-n5').style.opacity = level === 'N5' ? '1' : '0.5';
            document.getElementById('btn-mock-n4').style.opacity = level === 'N4' ? '1' : '0.5';

            const container = document.getElementById('mock-list-container');
            container.innerHTML = '';

            const questions = mockQuestionsDB[level] || [];
            if (questions.length === 0) {
                container.innerHTML = '<div style="color:#94a3b8; text-align:center; margin-top:20px;">æš«ç„¡å§”è¨—è³‡æ–™</div>';
                return;
            }

            // Group by batch (vXX)
            const batches = {};
            questions.forEach(q => {
                const batch = q.metadata?.batch || (q.tags && q.tags.find(t => t.startsWith('v') && t.length === 3)) || 'v01';
                if (!batches[batch]) {
                    batches[batch] = { total: 0, vocab: 0, grammar: 0, reading: 0, questions: [] };
                }
                batches[batch].total++;
                batches[batch].questions.push(q);

                // Count types
                const cat = q.category ? q.category.toLowerCase() : 'vocabulary';
                if (cat.includes('vocab') || cat.includes('èªå½™')) batches[batch].vocab++;
                else if (cat.includes('grammar') || cat.includes('æ–‡æ³•')) batches[batch].grammar++;
                else if (cat.includes('reading') || cat.includes('è®€è§£')) batches[batch].reading++;
            });

            // Render list
            Object.keys(batches).sort().forEach(batch => {
                const data = batches[batch];
                const resultKey = `${level}-${batch}`;
                const pastResult = mockResults[resultKey];

                const card = document.createElement('div');
                card.style.background = 'rgba(255,255,255,0.05)';
                card.style.border = '1px solid rgba(255,255,255,0.1)';
                card.style.borderRadius = '8px';
                card.style.padding = '15px';
                card.style.marginBottom = '10px';
                card.style.display = 'flex';
                card.style.justifyContent = 'space-between';
                card.style.alignItems = 'center';

                let statsHtml = `
                    <div style="font-size:0.85rem; color:#94a3b8; margin-top:5px;">
                        èªå½™: ${data.vocab} | æ–‡æ³•: ${data.grammar} | è®€è§£: ${data.reading}
                    </div>
                `;

                let resultHtml = pastResult
                    ? `<div style="color:#fbbf24; font-weight:bold; font-size:0.9rem;">æœ€ä½³ç´€éŒ„: ${pastResult.score}/${pastResult.total} (${Math.round(pastResult.score / pastResult.total * 100)}%)</div>`
                    : `<div style="color:#64748b; font-size:0.9rem;">å°šæœªåŸ·è¡Œ</div>`;

                card.innerHTML = `
                    <div>
                        <div style="font-weight:bold; font-size:1.1rem; color:#d946ef;">${level} å§”è¨— - å›åˆ ${batch.replace('v', '')}</div>
                        ${statsHtml}
                        ${resultHtml}
                    </div>
                    <button class="tool-btn" style="background:linear-gradient(45deg, #8b5cf6, #d946ef); padding:10px 20px;" 
                        onclick="startMockTest('${level}', '${batch}')">
                        é–‹å§‹åŸ·è¡Œ
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function startMockTest(level, batch) {
            const questions = mockQuestionsDB[level].filter(q => {
                const qBatch = q.metadata?.batch || (q.tags && q.tags.find(t => t.startsWith('v') && t.length === 3)) || 'v01';
                return qBatch === batch;
            });

            if (questions.length === 0) {
                alert("è©²å›åˆæ²’æœ‰é¡Œç›®ï¼");
                return;
            }

            // Setup Quiz Mode
            isMockMode = true;
            currentMockBatch = `${level}-${batch}`;
            quizList = [...questions]; // Use all questions in batch

            // Reset Quiz State
            currentIdx = 0;
            score = 0;
            currentHearts = 3; // Fixed hearts for mock? Or infinite? Let's assume standard 3 hearts for challenge, or maybe infinite for mock.
            // User requested "Simulation", usually implies standard test conditions. 
            // Let's disable hearts for Mock Mode (Standard JLPT doesn't fail you immediately), 
            // OR keep it but make it just for visual. 
            // Let's set hearts to 99 to prevent fail-out, or just ignore hearts in mock mode.
            // For now, I'll give 5 hearts to be generous.
            currentHearts = 5;

            document.getElementById('mock-test-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');

            showQuestion();
        }

        function finishMockTest() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('mock-result-screen').classList.remove('hidden');

            const total = quizList.length;
            const percentage = Math.round((score / total) * 100);

            // 1. Score
            document.getElementById('mock-final-score').innerText = score;

            // 2. Breakdown
            let vocabScore = 0, vocabTotal = 0;
            let grammarScore = 0, grammarTotal = 0;
            let readingScore = 0, readingTotal = 0;

            // We need to track which questions were answered correctly. 
            // Since the current engine just tracks global 'score', we might need to reconstruct it 
            // or just show global stats for now. 
            // To properly show breakdown, we'd need to track correctness per question ID.
            // For this iteration, I will show the Total Breakdown vs Global Score, 
            // and maybe just list the counts. 
            // *Self-correction*: The user wants "å„é …é¡Œå‹çš„è¡¨ç¾". 
            // I'll assume for now we just show the total counts vs the global score, 
            // as tracking per-category correctness requires modifying `checkAnswer`.
            // I will modify `checkAnswer` in a separate step if needed, but for now let's show a summary.

            // Actually, let's just show the totals for the batch.
            // "èªå½™: ?/10, æ–‡æ³•: ?/10..." -> I can't know the exact split of *correct* answers without tracking.
            // I will add a simple tracker in `checkAnswer` via a global `mockTracker`.

            // 3. Message
            let msg = "";
            let char = "";
            if (percentage >= 80) {
                char = "ç¨‹å°æ™‚ & é™¸å…‰";
                msg = "ã€Œé…åˆå®Œç¾ï¼é€™æ¬¡çš„å§”è¨—å®Œæˆå¾—éå¸¸å‡ºè‰²ã€‚ã€(åŒæ­¥ç‡é«˜)";
            } else if (percentage >= 60) {
                char = "ç¨‹å°æ™‚";
                msg = "ã€Œé‚„ä¸éŒ¯å˜›ï¼ä½†æˆ‘è¦ºå¾—æˆ‘å€‘é‚„å¯ä»¥åšå¾—æ›´å¥½ï¼Œå†ä¾†ä¸€æ¬¡ï¼Ÿã€";
            } else {
                char = "é™¸å…‰";
                msg = "ã€ŒåŒæ­¥ç‡å¤ªä½äº†ã€‚å†·éœä¸‹ä¾†ï¼Œä»”ç´°çœ‹æ¸…æ¥šæ¯ä¸€å€‹ç´°ç¯€ã€‚ã€";
            }
            document.getElementById('mock-char-msg').innerHTML = `<strong style="color:#d946ef;">${char}</strong><br>${msg}`;

            // 4. Rewards
            const reward = score * mockRewardMultiplier;
            document.getElementById('mock-reward-display').innerText = reward;

            // Save Result
            if (currentMockBatch) {
                const prev = mockResults[currentMockBatch] || { score: 0 };
                if (score > prev.score) {
                    mockResults[currentMockBatch] = { score: score, total: total, timestamp: Date.now() };
                    localStorage.setItem('jlpt_mock_results', JSON.stringify(mockResults));
                }
            }

            // Give Rewards
            userShards += reward;
            localStorage.setItem('jlpt_n5_shards', userShards);
        }

        function closeMockResult() {
            document.getElementById('mock-result-screen').classList.add('hidden');
            document.getElementById('mock-test-screen').classList.remove('hidden');
            renderMockRounds(currentMockBatch.split('-')[0]); // Refresh list
            isMockMode = false;
            currentMockBatch = null;
        }

        // Hook into existing logic
        // We need to modify `nextQuestion` to call `finishMockTest` instead of `showResult` when in mock mode.
        // And `checkAnswer` to track mock stats.

        let mockStats = { vocab: 0, grammar: 0, reading: 0 };

        // I will override the existing `nextQuestion` and `checkAnswer` or modify them.
        // Since I can't easily modify the middle of a function with `replace_file_content` without context,
        // I will append overrides at the end of the script.

        const originalNextQuestion = window.nextQuestion || nextQuestion;
        window.nextQuestion = function () {
            if (currentIdx < quizList.length - 1) {
                currentIdx++;
                showQuestion();
            } else {
                if (isMockMode) {
                    finishMockTest();
                } else {
                    showResult();
                }
            }
        };

        const originalCheckAnswer = window.checkAnswer || checkAnswer;
        // We need to intercept checkAnswer to track category scores for Mock Mode
        // But checkAnswer is likely defined inside the main script block. 
        // I'll redefine it here to include the hook.

        // Update finishMockTest to use the tracked stats
        const originalFinishMockTest = finishMockTest;
        finishMockTest = function () {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('mock-result-screen').classList.remove('hidden');

            const total = quizList.length;
            const percentage = Math.round((score / total) * 100);

            document.getElementById('mock-final-score').innerText = score;

            // Breakdown Display
            // Count totals for this batch
            let batchTotals = { vocab: 0, grammar: 0, reading: 0 };
            quizList.forEach(q => {
                const cat = q.category ? q.category.toLowerCase() : 'vocabulary';
                if (cat.includes('vocab') || cat.includes('èªå½™')) batchTotals.vocab++;
                else if (cat.includes('grammar') || cat.includes('æ–‡æ³•')) batchTotals.grammar++;
                else if (cat.includes('reading') || cat.includes('è®€è§£')) batchTotals.reading++;
            });

            document.getElementById('mock-breakdown').innerHTML = `
                <div style="margin-bottom:5px;">èªå½™: <b>${mockStats.vocab}</b> / ${batchTotals.vocab}</div>
                <div style="margin-bottom:5px;">æ–‡æ³•: <b>${mockStats.grammar}</b> / ${batchTotals.grammar}</div>
                <div style="margin-bottom:5px;">è®€è§£: <b>${mockStats.reading}</b> / ${batchTotals.reading}</div>
            `;

            // Reset stats
            mockStats = { vocab: 0, grammar: 0, reading: 0 };

            // ... (Rest of logic: Message, Rewards, Save)
            let msg = "";
            let char = "";
            if (percentage >= 80) {
                char = "ç¨‹å°æ™‚ & é™¸å…‰";
                msg = "ã€Œé…åˆå®Œç¾ï¼é€™æ¬¡çš„å§”è¨—å®Œæˆå¾—éå¸¸å‡ºè‰²ã€‚ã€(åŒæ­¥ç‡é«˜)";
            } else if (percentage >= 60) {
                char = "ç¨‹å°æ™‚";
                msg = "ã€Œé‚„ä¸éŒ¯å˜›ï¼ä½†æˆ‘è¦ºå¾—æˆ‘å€‘é‚„å¯ä»¥åšå¾—æ›´å¥½ï¼Œå†ä¾†ä¸€æ¬¡ï¼Ÿã€";
            } else {
                char = "é™¸å…‰";
                msg = "ã€ŒåŒæ­¥ç‡å¤ªä½äº†ã€‚å†·éœä¸‹ä¾†ï¼Œä»”ç´°çœ‹æ¸…æ¥šæ¯ä¸€å€‹ç´°ç¯€ã€‚ã€";
            }
            document.getElementById('mock-char-msg').innerHTML = `<strong style="color:#d946ef;">${char}</strong><br>${msg}`;

            const reward = score * mockRewardMultiplier;
            document.getElementById('mock-reward-display').innerText = reward;

            if (currentMockBatch) {
                const prev = mockResults[currentMockBatch] || { score: 0 };
                if (score > prev.score) {
                    mockResults[currentMockBatch] = { score: score, total: total, timestamp: Date.now() };
                    localStorage.setItem('jlpt_mock_results', JSON.stringify(mockResults));
                }
            }

            userShards += reward;
            localStorage.setItem('jlpt_n5_shards', userShards);
        };

        function renderCategories(level = null) {
            const container = document.getElementById('category-container');
            if (!container) return;
            container.innerHTML = '';

            // Use normalQuestionsDB for categories
            const targetDB = normalQuestionsDB.length > 0 ? normalQuestionsDB : allQuestions;
            const sections = [...new Set(targetDB.map(q => q.section))].sort();

            if (sections.length === 0) {
                container.innerHTML = '<div style="color:#aaa;">ç„¡é¡Œç›®è³‡æ–™</div>';
                return;
            }

            if (level === null) {
                // First level: Show N5 / N4 main categories
                const levels = ['N5', 'N4'];
                levels.forEach(lvl => {
                    const div = document.createElement('div');
                    div.className = 'cat-card';
                    div.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                    div.style.minHeight = '80px';
                    div.onclick = () => renderCategories(lvl);
                    div.innerHTML = `<div style="font-weight:bold; font-size:1.5rem; color:white;">${lvl} Level</div>`;
                    container.appendChild(div);
                });
                // Check for other categories
                const hasOther = sections.some(s => s && !s.startsWith('N5') && !s.startsWith('N4'));
                if (hasOther) {
                    const div = document.createElement('div');
                    div.className = 'cat-card';
                    div.onclick = () => renderCategories('Other');
                    div.innerHTML = `<div style="font-weight:bold; font-size:1.1rem; color:var(--cheng-blue);">Other</div>`;
                    container.appendChild(div);
                }
            } else {
                // Second level: Show sub-categories
                const backBtn = document.createElement('div');
                backBtn.className = 'cat-card'; backBtn.style.background = '#334155';
                backBtn.style.display = 'flex'; backBtn.style.alignItems = 'center'; backBtn.style.justifyContent = 'center';
                backBtn.onclick = () => renderCategories(null);
                backBtn.innerHTML = `<div style="font-weight:bold; font-size:1.1rem; color:#cbd5e1;">â¬… è¿”å›</div>`;
                container.appendChild(backBtn);

                const filteredSections = sections.filter(sec => {
                    if (!sec) return false;
                    if (level === 'Other') return !sec.startsWith('N5') && !sec.startsWith('N4');
                    return sec.startsWith(level);
                });

                filteredSections.forEach(sec => {
                    const count = targetDB.filter(q => q.section === sec).length;
                    const div = document.createElement('div');
                    div.className = 'cat-card';
                    div.onclick = () => openSetup(sec);
                    div.innerHTML = `<div style="font-weight:bold; font-size:1.1rem; color:var(--cheng-blue);">${sec}</div><div style="font-size:0.8rem; color:#cbd5e1;">${count} é¡Œ</div>`;
                    container.appendChild(div);
                });
            }
        }

        function updateDashboard() {
            document.getElementById('stat-total').innerText = userStats.total;
            const acc = userStats.total === 0 ? 0 : Math.round((userStats.correct / userStats.total) * 100);
            document.getElementById('stat-accuracy').innerText = acc + "%";

            const uniqueCount = Object.keys(collectedPhotos).length;
            const statPhotoCount = document.getElementById('stat-photo-count');
            if (statPhotoCount) statPhotoCount.innerText = `${uniqueCount}/${photoDB.length}`;
            document.getElementById('stat-streak').innerText = userStats.streak || 0;

            document.getElementById('shard-count').innerText = userShards;
            document.getElementById('gacha-shard-display').innerText = userShards;

            document.getElementById('stat-wrong').innerText = wrongQuestions.length;
        }

        // --- æš—æˆ¿åŠŸèƒ½ (ä¿®å¾©é‚è¼¯) ---
        function openDarkroom() {
            // Robust filter: handle both ID strings and objects
            const validWrong = wrongQuestions.filter(item => {
                const id = (typeof item === 'object' && item !== null) ? item.id : item;
                return allQuestions.some(q => q.id === id);
            }).map(item => (typeof item === 'object' && item !== null) ? item.id : item);

            if (validWrong.length === 0) {
                if (wrongQuestions.length > 0) {
                    alert("æª¢æ¸¬åˆ°ç„¡æ•ˆçš„éŒ¯é¡Œç´€éŒ„ï¼Œå·²è‡ªå‹•æ¸…é™¤ã€‚");
                    wrongQuestions = [];
                    localStorage.setItem('jlpt_n5_wrong_list', JSON.stringify([]));
                    updateDashboard();
                }
                return alert("æš—æˆ¿æ˜¯ç©ºçš„");
            }
            quizList = allQuestions.filter(q => validWrong.includes(q.id)).sort(() => Math.random() - 0.5);
            startQuizProcess();
        }

        function openDarkroomList() {
            const listContainer = document.getElementById('darkroom-list-container');
            listContainer.innerHTML = '';

            // Robust filter
            const validWrong = wrongQuestions.filter(item => {
                const id = (typeof item === 'object' && item !== null) ? item.id : item;
                return allQuestions.some(q => q.id === id);
            }).map(item => (typeof item === 'object' && item !== null) ? item.id : item);

            if (validWrong.length === 0) {
                listContainer.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px;">æš—æˆ¿å¾ˆä¹¾æ·¨ï¼Œæ²’æœ‰ç•°å¸¸ã€‚</div>';
                if (wrongQuestions.length > 0) {
                    wrongQuestions = [];
                    localStorage.setItem('jlpt_n5_wrong_list', JSON.stringify([]));
                    updateDashboard();
                }
            } else {
                validWrong.forEach(id => {
                    const q = allQuestions.find(item => item.id == id);
                    if (q) {
                        const cleanQ = q.question.replace(/<[^>]+>/g, '').substring(0, 30) + "...";
                        const row = document.createElement('div');
                        row.className = 'list-item darkroom-item';
                        row.innerHTML = `<div class="q-info"><span class="id-tag">#${q.id}</span><span class="info-text">${cleanQ}</span></div><button class="go-btn" onclick="startSingleQuestion(${q.id})"><span>ğŸ”§</span> ä¿®å¾©</button>`;
                        row.onclick = (e) => { if (e.target.tagName !== 'BUTTON') startSingleQuestion(q.id); };
                        listContainer.appendChild(row);
                    }
                });
            }
            document.getElementById('darkroom-list-modal').style.display = 'flex';
        }
        function closeDarkroomList() { document.getElementById('darkroom-list-modal').style.display = 'none'; }

        function startSingleQuestion(id) {
            const q = allQuestions.find(item => item.id == id);
            if (!q) return alert("é¡Œç›®è³‡æ–™éºå¤±");
            closeDarkroomList();
            quizList = [q];
            startQuizProcess();
        }

        // --- æŠ½å¡èˆ‡å…¶ä»–é‚è¼¯ ---
        function openGachaCenter() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('gacha-screen').classList.remove('hidden');
            document.getElementById('pull-results').innerHTML = '';
            updatePityDisplay();
            updateDashboard();
        }
        function closeGachaCenter() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('gacha-screen').classList.add('hidden');
        }
        function updatePityDisplay() {
            const pitySR = 80;
            const pitySQR = gachaConfig.pity.targetCount || 160;
            const srRem = pitySR - (globalPity.sr % pitySR);
            const sqrRem = pitySQR - (globalPity.sqr % pitySQR);

            document.getElementById('pity-display').innerText =
                `ç´¯ç©æŠ½æ•¸: ${globalPity.sqr} (ä¿åº• SR: ${srRem} / SQR: ${sqrRem})`;
        }
        function selectPool(poolId, el) {
            currentPool = poolId;
            document.querySelectorAll('.pool-card').forEach(c => c.classList.remove('active'));
            if (el) el.classList.add('active');
            else {
                // Find element if not passed
                // This might happen on init
            }
            updatePoolDisplay();
        }

        function renderGachaPools() {
            const container = document.getElementById('gacha-pool-container');
            container.innerHTML = '';
            let firstActive = null;
            let activeCount = 0;

            for (const [key, pool] of Object.entries(gachaConfig.pools)) {
                if (!pool.active) continue;
                activeCount++;
                if (!firstActive) firstActive = key;

                const div = document.createElement('div');
                div.className = `pool-card ${currentPool === key ? 'active' : ''}`;
                div.onclick = () => selectPool(key, div);

                let icon = 'â“';
                if (key === 'duo') icon = 'ğŸ‘¥';
                if (key === 'cheng') icon = 'ğŸ“·';
                if (key === 'lu') icon = 'âŒš';

                div.innerHTML = `
                    <div class="pool-icon">${icon}</div>
                    <div class="pool-title">${pool.name}</div>
                    <div style="font-size:0.6rem; color:#aaa;">${pool.text}</div>
                `;
                container.appendChild(div);
            }

            if (activeCount === 0) {
                container.innerHTML = '<div style="color:#aaa; padding:10px;">ç„¡å¯ç”¨å¡æ± </div>';
            } else if (!gachaConfig.pools[currentPool] || !gachaConfig.pools[currentPool].active) {
                // If current pool is invalid/inactive, switch to first active
                if (firstActive) {
                    currentPool = firstActive;
                    // Re-render to highlight correct one
                    renderGachaPools();
                }
            }
            updatePoolDisplay();
        }

        function updatePoolDisplay() {
            // Update logic for pool description text based on current pool config
            const pool = gachaConfig.pools[currentPool];
            if (pool) {
                const p = gachaConfig.rarityProb;
                document.getElementById('pool-desc').innerText = `N:${p.N}% | R:${p.R}% | SR:${p.SR}% | SQR:${p.SQR}%`;
            }
        }
        function executePull(amount) {
            if (photoDB.length === 0) return alert("ç›¸ç‰‡è³‡æ–™åº«æœªè¼‰å…¥ï¼Œç„¡æ³•æŠ½å¡");

            const totalCost = gachaConfig.cost * amount;
            if (userShards < totalCost) return alert("æ™‚é–“ç¢ç‰‡ä¸è¶³ï¼");

            userShards -= totalCost;
            updateDashboard();

            const results = [];
            for (let i = 0; i < amount; i++) {
                let isGuaranteed = (amount === 10 && i === 9);
                results.push(rollOne(isGuaranteed));
            }

            // Save results
            results.forEach(p => {
                if (!collectedPhotos[p.id]) collectedPhotos[p.id] = 0;
                collectedPhotos[p.id]++;
                p.isNew = (collectedPhotos[p.id] === 1);
            });
            localStorage.setItem('jlpt_n5_collection', JSON.stringify(collectedPhotos));

            showGachaResults(results);
            updatePityDisplay();
        }

        function rollOne(isGuaranteed10 = false) {
            // 1. Advanced Pity Check (Target)
            if (gachaConfig.pity.targetType !== 'rarity' && gachaConfig.pity.targetValue) {
                if (globalPity.sqr >= gachaConfig.pity.targetCount) {
                    if (gachaConfig.pity.targetType === 'photo') {
                        const target = photoDB.find(p => p.id === gachaConfig.pity.targetValue);
                        if (target) {
                            // Reset main pity (SQR)
                            globalPity.sqr = 0;
                            localStorage.setItem('jlpt_n5_global_pity', JSON.stringify(globalPity));
                            return target;
                        }
                    }
                    // 'char' target could be handled here if needed
                }
            }

            // 2. Determine Rarity
            let rarity = 'N';

            // Pity Thresholds
            const pitySR = 80;
            const pitySQR = gachaConfig.pity.targetCount || 160;

            if (globalPity.sqr >= pitySQR) {
                rarity = 'SQR';
            } else if (globalPity.sr >= pitySR) {
                rarity = 'SR';
            } else {
                // Probability Roll
                const r = Math.random() * 100;
                let cum = 0;
                if (r < (cum += gachaConfig.rarityProb.SQR)) rarity = 'SQR';
                else if (r < (cum += gachaConfig.rarityProb.SR)) rarity = 'SR';
                else if (r < (cum += gachaConfig.rarityProb.R)) rarity = 'R';
                else rarity = 'N';
            }

            // 10-pull Guarantee (Min Rarity)
            if (isGuaranteed10 && gachaConfig.guaranteed10 !== 'N') {
                const minRarity = gachaConfig.guaranteed10;
                const ranks = { 'N': 0, 'R': 1, 'SR': 2, 'SQR': 3 };
                if (ranks[rarity] < ranks[minRarity]) {
                    rarity = minRarity;
                }
            }

            // 3. Determine Character (Pool Logic)
            const pool = gachaConfig.pools[currentPool];
            let targetChar = null;
            if (pool) {
                const cr = Math.random() * 100;
                let ccum = 0;
                if (cr < (ccum += pool.charProb.duo)) targetChar = 'duo';
                else if (cr < (ccum += pool.charProb.lu)) targetChar = 'lu';
                else if (cr < (ccum += pool.charProb.cheng)) targetChar = 'cheng';
            }

            // 4. Filter Candidates
            let candidates = photoDB.filter(p => p.rarity === rarity);

            // Filter by Character
            if (targetChar) {
                const charCandidates = candidates.filter(p => {
                    const t = p.title || "";
                    if (targetChar === 'duo') return t.includes('é›™äºº') || (t.includes('ç¨‹') && t.includes('é™¸'));
                    if (targetChar === 'cheng') return t.includes('ç¨‹å°æ™‚') && !t.includes('é™¸');
                    if (targetChar === 'lu') return t.includes('é™¸å…‰') && !t.includes('ç¨‹');
                    return true;
                });
                if (charCandidates.length > 0) candidates = charCandidates;
            }

            // No Duplicate Logic
            if (gachaConfig.noDuplicate) {
                const unowned = candidates.filter(p => !collectedPhotos[p.id]);
                if (unowned.length > 0) candidates = unowned;
            }

            // Final Pick
            if (candidates.length === 0) {
                // Fallback
                candidates = photoDB;
            }
            const result = candidates[Math.floor(Math.random() * candidates.length)];

            // Update Pity
            globalPity.total++;
            if (result.rarity === 'SQR') globalPity.sqr = 0; else globalPity.sqr++;
            if (result.rarity === 'SR' || result.rarity === 'SQR') globalPity.sr = 0; else globalPity.sr++;

            localStorage.setItem('jlpt_n5_global_pity', JSON.stringify(globalPity));

            return result;
        }

        function showGachaResults(results) {
            const container = document.getElementById('pull-results');
            container.innerHTML = '';
            results.forEach((card, i) => {
                setTimeout(() => {
                    displayPullResult(card, container);
                }, i * 150);
            });
        }

        function displayPullResult(card, container) {
            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex'; wrapper.style.flexDirection = 'column'; wrapper.style.alignItems = 'center'; wrapper.style.marginBottom = '10px';
            wrapper.style.overflow = 'hidden'; wrapper.style.animation = 'zoomIn 0.3s backwards';

            let color = '#9ca3af';
            if (card.rarity == 'R') color = '#3b82f6';
            if (card.rarity == 'SR') color = '#eab308';
            if (card.rarity == 'SQR') color = '#ffd700';

            const rankDiv = document.createElement('div');
            rankDiv.innerText = card.rarity; rankDiv.style.color = color; rankDiv.style.fontWeight = 'bold'; rankDiv.style.fontFamily = 'monospace'; rankDiv.style.fontSize = '1rem'; rankDiv.style.marginBottom = '2px';

            const cardDiv = document.createElement('div');
            cardDiv.className = 'mini-card';
            cardDiv.style.borderColor = color; cardDiv.style.cursor = 'pointer'; cardDiv.style.width = '100%';
            cardDiv.onclick = function () { openLightbox(card); };
            cardDiv.innerHTML = `<img src="${card.path}" style="width:100%; height:100%; object-fit:cover;">${card.isNew ? '<div class="mini-new-badge">NEW</div>' : ''}`;

            const nameDiv = document.createElement('div');
            nameDiv.innerText = card.title; nameDiv.style.fontSize = '0.75rem'; nameDiv.style.marginTop = '4px'; nameDiv.style.color = '#cbd5e1'; nameDiv.style.whiteSpace = 'nowrap'; nameDiv.style.overflow = 'hidden'; nameDiv.style.textOverflow = 'ellipsis'; nameDiv.style.maxWidth = '100%';

            wrapper.appendChild(rankDiv); wrapper.appendChild(cardDiv); wrapper.appendChild(nameDiv);
            container.appendChild(wrapper);
        }

        // --- æ¸¬é©—æµç¨‹ ---
        function openSetup(cat) {
            tempSelectedCategory = cat;
            document.getElementById('setup-modal').style.display = 'flex';
            document.getElementById('challenge-toggle').checked = false;
            toggleChallengeMode();

            // å¤šé¸å€å¡Šé‚è¼¯
            const selArea = document.getElementById('category-selection-area');
            const container = document.getElementById('multi-select-container');
            container.innerHTML = '';

            if (cat === 'ALL') {
                selArea.style.display = 'block';
                const sections = [...new Set(allQuestions.map(q => q.section))].sort();
                sections.forEach(sec => {
                    const label = document.createElement('label');
                    label.className = 'filter-chk';
                    label.style.color = 'white';
                    label.innerHTML = `<input type="checkbox" class="cat-checkbox" value="${sec}" checked> ${sec}`;
                    container.appendChild(label);
                });
            } else {
                selArea.style.display = 'none';
            }
        }

        function selectSubset(type) {
            const boxes = document.querySelectorAll('.cat-checkbox');
            boxes.forEach(box => {
                if (type === 'ALL') box.checked = true;
                else if (type === 'N5') box.checked = box.value.startsWith('N5');
                else if (type === 'N4') box.checked = box.value.startsWith('N4');
            });
        }

        function closeSetup() { document.getElementById('setup-modal').style.display = 'none'; }
        function selectCount(n, b) { tempSelectedCount = n; document.querySelectorAll('.count-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); }
        function toggleChallengeMode() { const chk = document.getElementById('challenge-toggle').checked; document.getElementById('heart-setting').style.display = chk ? 'block' : 'none'; if (!chk) { document.getElementById('timer-toggle').checked = false; toggleTimerMode(); } }
        function toggleTimerMode() { const chk = document.getElementById('timer-toggle').checked; document.getElementById('timer-setting').style.display = chk ? 'block' : 'none'; }

        function confirmStart() {
            isChallengeMode = document.getElementById('challenge-toggle').checked; isTimerMode = false;
            if (isChallengeMode) { maxHearts = parseInt(document.getElementById('heart-count').value); currentHearts = maxHearts; if (document.getElementById('timer-toggle').checked) { isTimerMode = true; timeLimit = parseInt(document.getElementById('time-limit').value); } }
            closeSetup(); startQuiz();
        }

        function startQuiz() {
            // Use normalQuestionsDB for Normal Quiz
            const sourceDB = normalQuestionsDB.length > 0 ? normalQuestionsDB : allQuestions;
            let f = [];
            if (tempSelectedCategory === 'ALL') {
                // å¤šé¸æ¨¡å¼ï¼šè®€å–å‹¾é¸çš„é¡åˆ¥
                const checkedCats = Array.from(document.querySelectorAll('.cat-checkbox:checked')).map(c => c.value);
                if (checkedCats.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¡åˆ¥ï¼");
                f = sourceDB.filter(q => checkedCats.includes(q.section));
            } else {
                // å–®é¸æ¨¡å¼
                f = sourceDB.filter(q => q.section === tempSelectedCategory);
            }

            if (f.length === 0) return alert("ç„¡é¡Œç›®");
            quizList = f.sort(() => Math.random() - 0.5).slice(0, Math.min(tempSelectedCount, f.length));
            isMockMode = false; // Ensure Mock Mode is off
            startQuizProcess();
        }

        function startQuizProcess() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');

            const hd = document.getElementById('hearts-container');
            const sd = document.getElementById('score-display');
            const td = document.getElementById('timer-display');

            if (isChallengeMode) {
                hd.style.display = 'block'; hd.innerText = "â¤".repeat(currentHearts);
                sd.style.display = 'none';
                td.style.display = isTimerMode ? 'block' : 'none';
            } else {
                hd.style.display = 'none'; td.style.display = 'none'; sd.style.display = 'inline';
            }

            currentIdx = 0; score = 0; isGameOver = false; pendingHeal = false;
            showQuestion();
        }

        // å¼·åˆ¶é€€å‡º
        window.forceExit = function () {
            if (confirm("ç¢ºå®šè¦ä¸­æ–·é€£çµï¼Œå¼·åˆ¶é€€å‡ºç…§ç‰‡å—ï¼Ÿ\n(ç›®å‰çš„é€²åº¦å°‡åˆ—å…¥çµç®—)")) {
                if (timerInterval) clearInterval(timerInterval);
                isGameOver = true;
                showResult(true);
            }
        };

        function showQuestion() {
            if (timerInterval) clearInterval(timerInterval);
            if (currentIdx >= quizList.length) { showResult(); return; }

            const q = quizList[currentIdx];
            // é˜²å‘†æ©Ÿåˆ¶ï¼šå¦‚æœé¡Œç›®ç‚ºç©ºï¼Œç›´æ¥çµç®—
            if (!q) { showResult(); return; }

            document.getElementById('q-progress').innerText = `Q.${currentIdx + 1}/${quizList.length}`;
            document.getElementById('score-display').innerText = "SCORE:" + score;
            document.getElementById('q-category-tag').innerText = q.section || q.category || 'General';
            document.getElementById('q-db-id').innerText = q.id;
            document.getElementById('q-text').innerHTML = q.question;

            // Hide post-answer elements initially
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('feedback-card').style.display = 'none';

            document.getElementById('copy-msg').style.display = 'none';
            document.getElementById('hearts-container').classList.remove('shake-anim', 'heal-anim');

            const btnBug = document.getElementById('btn-report-bug');
            if (btnBug) { btnBug.innerHTML = "<span>âš </span> é¡Œç›®ç•°å¸¸"; btnBug.classList.remove('disabled'); }

            const c = document.getElementById('options-container'); c.innerHTML = '';
            let ops = q.options.map((t, i) => ({ t: t, ok: (i === q.answer) })).sort(() => Math.random() - 0.5);
            ops.forEach(o => {
                const b = document.createElement('button'); b.className = 'option-btn'; b.innerText = o.t;
                if (o.ok) b.dataset.correct = "true";
                b.onclick = function () { checkAnswer(this, false) }; c.appendChild(b);
            });
            if (isTimerMode) startTimer();
        }

        function startTimer() {
            timeLeft = timeLimit; document.getElementById('timer-display').innerText = `â³ ${timeLeft}s`;
            timerInterval = setInterval(() => {
                timeLeft--; document.getElementById('timer-display').innerText = `â³ ${timeLeft}s`;
                if (timeLeft <= 0) { clearInterval(timerInterval); checkAnswer(null, true); }
            }, 1000);
        }


        // --- æª¢æŸ¥ç­”æ¡ˆ ---
        function updateHearts() {
            const hd = document.getElementById('hearts-container');
            if (hd) hd.innerText = "â¤".repeat(Math.max(0, currentHearts));
        }

        function checkAnswer(btn, isTimeOut) {
            if (timerInterval) clearInterval(timerInterval);
            const q = quizList[currentIdx];
            const isCorrect = btn && btn.dataset.correct === "true";

            // Disable options
            const opts = document.querySelectorAll('.option-btn');
            opts.forEach(o => {
                o.disabled = true;
                if (o.dataset.correct === "true") o.classList.add('correct');
                else o.classList.add('fade');
            });

            if (btn && !isCorrect) {
                btn.classList.add('wrong');
                btn.classList.remove('fade');
                document.getElementById('hearts-container').classList.add('shake-anim');
                if (navigator.vibrate) navigator.vibrate(200);
            }

            // Update Stats
            if (isCorrect) {
                score += 100;
                userStats.correct++;
                userStats.streak++;
                if (userStats.streak % 5 === 0) {
                    score += 50;
                    showToast(`é€£å° ${userStats.streak} é¡Œï¼åŠ åˆ†ï¼`);
                }
                // Random Shard Drop
                if (Math.random() < 0.3) {
                    const shard = Math.floor(Math.random() * 5) + 1;
                    userShards += shard;
                    localStorage.setItem('jlpt_n5_shards', userShards);
                    showToast(`ç²å¾— ${shard} å€‹æ™‚å…‰ç¢ç‰‡ï¼`);
                }
                // Challenge Mode Heal
                if (isChallengeMode && pendingHeal && currentHearts < maxHearts) {
                    currentHearts++;
                    updateHearts();
                    pendingHeal = false;
                }
            } else {
                userStats.streak = 0;
                if (isChallengeMode) {
                    currentHearts--;
                    updateHearts();
                    if (currentHearts <= 0) isGameOver = true;
                }
                if (!wrongQuestions.includes(q.id)) {
                    wrongQuestions.push(q.id);
                    try { localStorage.setItem('jlpt_n5_wrong_list', JSON.stringify(wrongQuestions)); } catch (e) { }
                }
            }
            userStats.total++;
            try { localStorage.setItem('jlpt_n5_stats_v18', JSON.stringify(userStats)); } catch (e) { }
            updateDashboard();

            // Populate Feedback Card
            const charName = isCorrect ? "ç¨‹å°æ™‚" : "é™¸å…‰";
            const quotes = isCorrect ? chengQuotes : luQuotes;
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];

            document.getElementById('fb-char-name').innerText = charName;
            document.getElementById('fb-char-msg').innerText = randomQuote;
            document.getElementById('fb-explanation').innerHTML = q.explanation || "ç„¡è§£æ";

            document.getElementById('feedback-card').style.display = 'block';

            // Next Button
            const nb = document.getElementById('next-btn');
            nb.style.display = 'block';
            nb.innerText = (isGameOver || currentIdx === quizList.length - 1) ? "æŸ¥çœ‹å ±å‘Š" : "ä¸‹ä¸€å¼µ â¯";
        }

        function nextQuestion() {
            if (isGameOver) { showResult(); return; }
            currentIdx++; if (currentIdx < quizList.length) showQuestion(); else showResult();
        }

        function showResult(isManualExit = false) {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('reward-container').style.display = 'none';

            let total = quizList.length;
            if (isManualExit) total = currentIdx + 1;

            const fs = total === 0 ? 0 : Math.round((score / total) * 100);
            document.getElementById('final-score').innerText = fs;

            const failImg = document.getElementById('fail-img-wrapper');
            const title = document.getElementById('result-title');
            const fbText = document.getElementById('feedback-text');
            const scoreCircle = document.getElementById('final-score');

            let earnedShards = 0;
            if (score > 0) {
                let base = score * 5; let multiplier = 1;
                if (isChallengeMode && !isManualExit) {
                    multiplier *= (6 - maxHearts) * 1.1;
                    if (isTimerMode) { if (timeLimit === 5) multiplier *= 2; else if (timeLimit === 12) multiplier *= 1.5; else if (timeLimit === 20) multiplier *= 1.1; }
                }
                earnedShards = Math.ceil(base * multiplier);
            }

            if ((isChallengeMode && isGameOver && !isManualExit) || (isManualExit && isChallengeMode && currentHearts <= 0)) {
                failImg.style.display = 'block';
                title.innerText = "MISSION FAILED"; title.style.color = "#ef4444"; scoreCircle.style.borderColor = "#ef4444";
                fbText.innerText = `åŒæ­¥ç‡æ­¸é›¶ã€‚\næœ¬æ¬¡ç²å¾— 0 ç¢ç‰‡ã€‚`;
            } else {
                failImg.style.display = 'none';
                title.innerText = isManualExit ? "MISSION ABORTED" : "MISSION COMPLETE";
                title.style.color = "white"; scoreCircle.style.borderColor = "#2d8cf0";

                userShards += earnedShards; localStorage.setItem('jlpt_n5_shards', userShards);
                updateDashboard();

                let msg = isManualExit ? `é€£çµå·²ä¸­æ–·ã€‚<br>` : `å§”è¨—å®Œæˆã€‚<br>`;
                fbText.innerHTML = `${msg}ç²å¾— <span style="color:#ffd700; font-weight:bold;">ğŸ’  ${earnedShards}</span> æ™‚å…‰ç¢ç‰‡`;
            }
        }

        function openGallery() { document.getElementById('dashboard').classList.add('hidden'); document.getElementById('gallery-screen').classList.remove('hidden'); renderGallery(); }
        function closeGallery() { document.getElementById('dashboard').classList.remove('hidden'); document.getElementById('gallery-screen').classList.add('hidden'); }
        function renderGallery() {
            const c = document.getElementById('gallery-content'); c.innerHTML = '';
            const sort = document.getElementById('gallery-sort').value;
            const cc = Array.from(document.querySelectorAll('#filter-chars input:checked')).map(x => x.value);
            const rc = Array.from(document.querySelectorAll('#filter-ranks input:checked')).map(x => x.value);
            let f = photoDB.filter(p => { const cm = cc.some(c => p.character.includes(c) || (c === "ç¨‹å°æ™‚&é™¸å…‰" && p.character.includes("&"))); const rm = rc.includes(p.rarity); return cm && rm; });
            let grp = {}; f.forEach(p => { let k = sort === 'char' ? (p.character.includes("&") ? "ç¨‹å°æ™‚&é™¸å…‰" : p.character.includes("ç¨‹") ? "ç¨‹å°æ™‚" : p.character.includes("é™¸") ? "é™¸å…‰" : "å…¶ä»–") : p.rarity; if (!grp[k]) grp[k] = []; grp[k].push(p); });
            const co = ["ç¨‹å°æ™‚&é™¸å…‰", "ç¨‹å°æ™‚", "é™¸å…‰"]; const ro = ["SQR", "SR", "R", "N"];
            let sk = Object.keys(grp).sort((a, b) => sort === 'char' ? (co.indexOf(a) - co.indexOf(b)) : (ro.indexOf(a) - ro.indexOf(b)));
            sk.forEach(k => {
                const t = document.createElement('div'); t.className = 'group-title'; t.innerText = k; c.appendChild(t);
                const g = document.createElement('div'); g.className = 'gallery-grid';
                grp[k].forEach(p => {
                    const count = collectedPhotos[p.id] || 0; const own = count > 0;
                    const d = document.createElement('div'); d.className = `photo-card border-${p.rarity}`; d.onclick = () => { if (own) openLightbox(p) };
                    d.innerHTML = `${own ? `<img src="${p.path}" class="photo-img">` : `<div style="height:100%;background:#111;display:flex;justify-content:center;align-items:center;">ğŸ”’</div>`}<div class="photo-overlay">${own ? p.title : "???"}</div>${own ? `<div class="qty-badge">x${count}</div>` : ''}`;
                    g.appendChild(d);
                });
                c.appendChild(g);
            });
        }
        function openLightbox(p) { document.getElementById('lightbox').style.display = 'flex'; document.getElementById('lightbox-img').src = p.path; document.getElementById('lightbox-title').innerText = p.title; document.getElementById('lightbox-rarity').innerText = `[${p.rarity}] ${p.character}`; }
        function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }

        function openReportCenter() {
            const c = document.getElementById('report-list-container'); c.innerHTML = '';
            if (reportList.length == 0) c.innerHTML = '<div style="color:#aaa;padding:10px;">ç„¡å›å ±ç´€éŒ„</div>';
            else reportList.forEach(i => {
                const fullQ = allQuestions.find(q => q.id == i.id) || { question: "æœªçŸ¥é¡Œç›®" };
                const div = document.createElement('div');
                div.className = 'report-item';
                // Add click event to open preview
                div.onclick = (e) => { if (e.target.type !== 'checkbox') openReportPreview(i.id); };
                div.style.cursor = 'pointer';
                div.innerHTML = `<input type="checkbox" class="report-check" value="${i.id}" onclick="event.stopPropagation()"><div><div class="report-id">ID:${i.id}</div><div style="font-size:0.8rem;color:#cbd5e1;">${fullQ.question.substring(0, 20)}...</div></div>`;
                c.appendChild(div);
            });
            document.getElementById('report-modal').style.display = 'flex';
        }
        function closeReportCenter() { document.getElementById('report-modal').style.display = 'none'; }

        function openReportPreview(id) {
            const q = allQuestions.find(item => item.id == id);
            if (!q) return alert("é¡Œç›®è³‡æ–™éºå¤±");
            const content = document.getElementById('preview-content');
            content.innerHTML = `
                <div style="margin-bottom:10px;"><span style="color:#94a3b8;">ID:</span> ${q.id}</div>
                <div style="margin-bottom:10px;"><span style="color:#94a3b8;">é¡åˆ¥:</span> ${q.section}</div>
                <div style="margin-bottom:10px; font-size:1.1rem;">${q.question}</div>
                <div style="margin-bottom:10px; padding:10px; background:rgba(0,0,0,0.3); border-radius:4px;">
                    ${q.options.map((o, i) => `<div style="${i === q.answer ? 'color:var(--success); font-weight:bold;' : 'color:#cbd5e1;'}">${i + 1}. ${o} ${i === q.answer ? 'âœ…' : ''}</div>`).join('')}
                </div>
                <div style="font-size:0.9rem; color:#cbd5e1; line-height:1.4;">
                    <span style="color:#f59e0b;">è§£æ:</span><br>${q.explanation}
                </div>
            `;
            document.getElementById('report-preview-modal').style.display = 'flex';
        }
        function closeReportPreview() { document.getElementById('report-preview-modal').style.display = 'none'; }
        function toggleSelectAllReports() { document.querySelectorAll('.report-check').forEach(c => c.checked = !c.checked); }
        function resolveReports() { const ids = Array.from(document.querySelectorAll('.report-check:checked')).map(c => parseInt(c.value)); if (ids.length == 0) return alert("æœªå‹¾é¸"); reportList = reportList.filter(i => !ids.includes(i.id)); localStorage.setItem('jlpt_n5_reports', JSON.stringify(reportList)); openReportCenter(); }
        function reportCurrentQuestion() { const q = quizList[currentIdx]; if (!reportList.some(i => i.id === q.id)) { reportList.push({ id: q.id }); localStorage.setItem('jlpt_n5_reports', JSON.stringify(reportList)); const btn = document.getElementById('btn-report-bug'); btn.innerHTML = "âœ… å·²å›å ±"; btn.classList.add('disabled'); if (isChallengeMode) { pendingHeal = true; alert("å›å ±æˆåŠŸï¼ä¸‹ä¸€é¡Œç­”å°å¯å›è¡€ã€‚"); } else alert("å·²è¨˜éŒ„ID"); } }

        function resetStats() { if (confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ç´€éŒ„(å«ç›¸ç‰‡)å—?")) { localStorage.clear(); location.reload(); } }
        function copyToClipboard() { const q = quizList[currentIdx]; let text = `é¡Œç›®ï¼š${q.question.replace(/<[^>]*>/g, '')}\né¸é …ï¼š\n`; q.options.forEach((opt, i) => { text += `${i + 1}. ${opt}\n`; }); text += `\nè«‹è§£æé€™é¡Œ N5 æ—¥æ–‡ã€‚`; navigator.clipboard.writeText(text).then(() => { const msg = document.getElementById('copy-msg'); msg.style.display = 'inline-block'; setTimeout(() => { msg.style.display = 'none'; }, 2000); }); }
        function copyId() { navigator.clipboard.writeText(document.getElementById('q-db-id').innerText); alert("IDå·²è¤‡è£½"); }
        function closeGacha() { document.getElementById('gacha-overlay').style.display = 'none'; document.getElementById('gacha-card-reveal').classList.remove('show'); }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }
    </script>
</body>

</html>